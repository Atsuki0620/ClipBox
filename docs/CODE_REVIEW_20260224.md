# ClipBox コードレビュー 問題追跡

**作成日**: 2026-02-24 / **最終更新**: 2026-02-25
**対象ブランチ**: feature/streamlit-ui-implementation

---

## カテゴリ A：バグ・データ破損リスク

### A-1：外付けHDD未接続時の `is_available=0` 一括上書き

`scan_and_update` は外付けHDDが未接続でスキャンがスキップされた場合でも、HDD上の全レコードを `is_available=0` に更新してしまう。

**✅ 解決済み (2026-02-25)** — `scanner.py`: `is_available=0` 更新をスキャン済みディレクトリ配下に限定

---

### A-2：`essential_filename` 衝突時のサイレント上書き

異なるフォルダに同名ファイルが存在する場合、2つ目のスキャン時に1つ目のレコードが上書きされ情報が消失する。

**📋 技術的負債** — 個人利用では同名ファイルが別フォルダに存在するケースは稀

---

### A-3：`viewing_history` と `play_history` の二重管理によるトランザクション不整合

再生操作が3つの独立したトランザクションに分割されており、`insert_play_history` が失敗すると `viewing_history` のみ記録された不整合な状態になる。

**✅ 解決済み (2026-02-25)** — `insert_play_history` に `conn` 引数を追加し、`play_video` 内で同一トランザクションで記録

---

### A-4：`likes` テーブルへの無制限追記（レート制御なし）

`add_like` は呼び出されるたびに無条件でレコードを INSERT し、連打などによる重複蓄積を防ぐ仕組みがない。

**📋 技術的負債** — 現規模では蓄積量は微小

---

### A-5：`migration_history.txt` ベースのマイグレーション管理の脆弱性

マイグレーション完了判定がDB外のテキストファイルに依存しており、ファイル削除時に全マイグレーションが再実行される。

**📋 技術的負債** — 現マイグレーションは再実行しても安全

---

### A-6：`st.cache_data` と `st.rerun()` の組み合わせによる古いデータの表示

再生・判定操作後に `st.rerun()` が走ってもキャッシュが残るため、KPIや視聴回数が最大TTL秒間更新されない。

**✅ 解決済み (2026-02-25)** — 書き込み操作後に `ui_cache.xxx.clear()` を追加

---

### A-7：Windows における `st.ctime` のセマンティクス誤解

`file_created_at` に記録される値が、ファイルコピー・OneDrive同期などでユーザーが期待する「元のファイル作成日」と乖離することがある。

**📋 技術的負債** — ソート順の直感的差異のみ、実害なし

---

### A-8：`detect_recently_accessed_files` の `st.atime` 依存による機能不全リスク

Windows では `NtfsDisableLastAccessUpdate` がデフォルト有効のため `atime` が更新されず、ファイルアクセス検知が実質機能しない環境が多い。

**📋 技術的負債** — 起動時自動検知は無効化済み

---

### A-9：`_process_file` で UPDATE 時に `file_size` が更新されない

既存レコードのUPDATE文に `file_size` が含まれておらず、ファイルサイズが変更されても分析ダッシュボードの容量集計に反映されない。

**📋 技術的負債** — ファイルサイズ変更は稀

---

### A-10：`init_database` の二重呼び出し

`check_and_init_database` 内で `app_service.init_database()` が2回呼ばれており、ALTER TABLE 文などが不必要に二重実行される。

**✅ 解決済み (2026-02-25)** — `check_and_init_database` の1回目呼び出しを削除

---

## カテゴリ B：パフォーマンス劣化リスク

### B-1：ページネーションの全件取得・Python側スライス

`get_videos()` が全レコードを `fetchall()` し、キーワードフィルタ・ソート・ページスライスをすべてPython側で実行するため、動画数増加時に性能劣化する。

**📋 技術的負債** — 3,000件〜で劣化予定、現時点は問題なし

---

### B-2：`IN (?, ?, ...)` プレースホルダの SQLite 上限超過

`analysis_service.py` 等の `IN ({placeholders})` 句が動画 1,000 件超で `sqlite3.OperationalError: too many SQL variables` を引き起こす可能性がある。

**✅ 解決済み (2026-02-25)** — `_run_chunked_query` ヘルパーで900件チャンク分割

---

### B-3：`snapshot.py` の非原子的な複数 `executemany` による不完全スナップショット

スナップショット作成途中に例外が発生すると空のスナップショットファイルが残り、`list_snapshots` で列挙され続ける。

**📋 技術的負債** — 利用頻度低く手動削除可能

---

### B-4：`auto_start_counters` のネスト接続による SQLite ロック競合

`play_video` の書き込みトランザクション中に `auto_start_counters` が別接続を開くため、`SQLITE_BUSY` エラーが発生しうる。

**✅ 解決済み (2026-02-25)** — `auto_start_counters(event_time, conn)` に `conn` 引数を追加

---

### B-5：OneDrive パス上での `rglob` スキャンの遅延リスク

スキャン対象にOneDriveパスが含まれる場合、ファイルオンデマンドが有効だとクラウド専用ファイルのダウンロードがトリガーされスキャンがブロックされる。

**📋 技術的負債** — ファイルオンデマンド無効化で回避可能

---

## カテゴリ C：保守性・拡張性の問題

### C-1：コア層への `streamlit` 依存（設計原則違反）

`core/app_service.py` が `import streamlit as st` と `@st.cache_data` デコレータを含み、「コア層はUIフレームワークに依存しない」原則に違反していた。

**✅ 解決済み (2026-02-25)** — `ui/cache.py` 新設、`core/app_service.py` から `streamlit` 依存を削除

---

### C-2：`_row_to_video()` の重複実装

`core/video_manager.py` と `ui/unrated_random_tab.py` にほぼ同一の `sqlite3.Row → Video` 変換ロジックが存在し、新カラム追加時に片方が取り残されるリスクがある。

**✅ 解決済み (2026-02-25)** — `video_from_row` をモジュールレベル関数に昇格、重複実装を統合

---

### C-3：後方互換 shim ファイルの乱立

`config_store.py`・`history_repository.py`・`file_ops.py` の3ファイルが実質 re-export のみを行う shim であり、機能の実装場所の把握が困難。

**📋 技術的負債** — 新規 import は追加されておらず混乱は限定的

---

### C-4：`app_service.py` のファサード責務の曖昧さ

単純な re-export と独自ロジックを持つ関数が混在しており、新機能をどこに書くべきか不明確。

**📋 技術的負債** — 個人開発規模では問題なし

---

### C-5：`FAVORITE_LEVEL_NAMES` と `level_to_display()` の二重管理

お気に入りレベルの表示名が `config.py` と `models.py` で独立管理され、表示形式も異なる（「レベル0」vs「Lv0」）。

**📋 技術的負債** — 新レベル追加頻度が低い間は問題なし

---

### C-6：テストの `monkeypatch` 二重パッチ依存（本番DB書き込みリスク）

`config.DATABASE_PATH` と `core.database.DATABASE_PATH` の両方をパッチしなければならず、片方を忘れると本番DBが破壊される。

**✅ 解決済み (2026-02-25)** — `tests/conftest.py` に `tmp_db` フィクスチャを新設

---

### C-7：`Video` データクラスのフラグフィールド肥大化

`is_available`・`is_deleted`・`is_judging`・`needs_selection` 等のフラグが直接 `Video` に追加されており、将来機能追加時にさらに肥大化する懸念がある。

**📋 技術的負債** — 将来機能追加時にリファクタ

---

### C-8：UI層からの直接DBアクセス

`ui/unrated_random_tab.py` と `ui/analysis_tab.py` が `get_db_connection()` を直接呼び出しており、UI→core→data のレイヤー原則に違反している。

**✅ 解決済み (2026-02-25)** — `VideoManager.get_unrated_random_videos` / `analysis_service.get_response_time_data` を追加

---

### C-9：`models.py` の `create_sort_key` における「タイトル:降順」の不正実装

`"タイトル:降順"` のキーとして `name[::-1]`（文字列逆順）が使われており、正しい辞書順降順にならない。

**✅ 解決済み (2026-02-25)** — `_ReverseStr` クラスで辞書順降順ソートを正しく実装

---

## サマリー

| 問題 | 深刻度 | 状態 |
|------|--------|------|
| A-1 | 🔴 高 | ✅ 解決済み (2026-02-25) |
| A-2 | 🟡 中 | 📋 技術的負債 |
| A-3 | 🟡 中 | ✅ 解決済み (2026-02-25) |
| A-4 | 🟢 低 | 📋 技術的負債 |
| A-5 | 🟡 中 | 📋 技術的負債 |
| A-6 | 🟡 中 | ✅ 解決済み (2026-02-25) |
| A-7 | 🟢 低 | 📋 技術的負債 |
| A-8 | 🔴 高 | 📋 技術的負債 |
| A-9 | 🟢 低 | 📋 技術的負債 |
| A-10 | 🟢 低 | ✅ 解決済み (2026-02-25) |
| B-1 | 🔴 高 | 📋 技術的負債 |
| B-2 | 🟡 中 | ✅ 解決済み (2026-02-25) |
| B-3 | 🟢 低 | 📋 技術的負債 |
| B-4 | 🟡 中 | ✅ 解決済み (2026-02-25) |
| B-5 | 🟢 低 | 📋 技術的負債 |
| C-1 | 🔴 高 | ✅ 解決済み (2026-02-25) |
| C-2 | 🟡 中 | ✅ 解決済み (2026-02-25) |
| C-3 | 🟢 低 | 📋 技術的負債 |
| C-4 | 🟡 中 | 📋 技術的負債 |
| C-5 | 🟢 低 | 📋 技術的負債 |
| C-6 | 🔴 高 | ✅ 解決済み (2026-02-25) |
| C-7 | 🟢 低 | 📋 技術的負債 |
| C-8 | 🟡 中 | ✅ 解決済み (2026-02-25) |
| C-9 | 🟢 低 | ✅ 解決済み (2026-02-25) |

**合計**: 24件 / **✅ 解決済み**: 11件 / **📋 技術的負債**: 13件
