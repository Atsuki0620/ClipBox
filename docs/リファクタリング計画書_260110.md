# ClipBox リファクタリング計画書（挙動維持・機能追加なし）
ファイル名案: `docs/REFACTOR_PLAN_NO_FEATURES.md`

進捗メモ（2026-01-10）
- Phase0〜Phase4 まで完了。UI は app_service 経由に統一し、SQL/設定/ファイル操作は集約済み。最終スモーク（起動→各タブ表示→再生/スキャン/履歴検知のエラー無し）を実施済み。

---

## 1) 背景と目的
- Streamlit に副作用とロジックが混在し肥大化している。将来の機能追加に備え、変更容易性・保守性を高める。
- 外部挙動（UI表示、DB更新タイミング、レコード内容、エラーメッセージ大枠）は一切変えない。

## 2) スコープ（やる/やらない）
- やる: ファイル/関数移動、責務分離、命名整理、依存方向整理、import整理。
- やらない: 新機能追加、仕様変更、UI導線追加、DBスキーマ破壊、HTML/CSS 分離（将来課題として言及のみ）。

## 3) 原則（UIに残す/追い出す）
- UIに残す: 画面レイアウト、`st.session_state`（UI状態のみ）、サービス呼び出しの薄い配線、成功/失敗メッセージ表示、`st.rerun()`。
- UIから追い出す: SQL/DB接続/集計/マイグレーション、Path操作、OS/プレイヤー起動、正規化・ソートキー生成・フィルタ適用・表示整形。

## 4) 集約ルール（分解しすぎない）
- `core/` は大きめモジュールに集約し、ファイル乱立を避ける。
- 分割は境界が明確で再利用頻度が高いものだけ（設定読込、DBアクセス、OS起動、ファイル操作）。
- SQL は `database.py` 1ファイルに集約（repo分割禁止）。肥大化してもセクションコメント＋関数粒度で可読性を担保。
- サービスも細分化しない。UI から呼ぶ入口は少数（1ファイル中心）に集約する。

## 5) 目標構造（依存方向含む）
- UI層: Streamlit（表示・入力・`session_state`・メッセージ表示・`st.rerun()`）
- Core層: アプリ操作ユースケース（スキャン、一覧表示、再生、履歴記録、判定、DB更新、統計表示、スナップショット作成/比較）＋正規化・ソートキー生成・フィルタ適用・表示整形
- Infra層: DB、ファイル操作、OS起動（副作用）
- 依存方向: UI → Core → Infra の一方向（逆依存なし）

## 6) 新ディレクトリ構成案（最小・集約型）
```
core/
  __init__.py
  app_service.py   # UIから呼ばれる入口を集約（再生/判定/スキャン/履歴検知/統計/スナップショット等）
  database.py      # DB接続初期化と全SQL（セクションコメント＋関数粒度、repo分割禁止）
  file_ops.py      # Path操作（rename/scan/access検知）とOS起動（プレイヤー起動）
  config_utils.py  # user_config.json と app_settings.json の読み書き（マージ含む）
  models.py        # dataclass + 純粋関数（正規化、判定済み判定、レベル表現 等）
```

## 7) 現状との差分（移動/統合マップ例）
- 旧 `scanner.py` → `core/file_ops.py` に統合（スキャン・ファイル検知）。
- 旧 `history_repository.py` / `video_repository.py` 等の SQL → `core/database.py` に集約（repo分割禁止）。
- 旧 `config.py` の設定読込 → `core/config_utils.py` へ移設（JSON マージ明文化）。
- 旧 `models` 分散ロジック → `core/models.py` に集約（正規化・レベル表現・判定関数）。
- 旧サービス分散（`scan_service.py` 等） → `core/app_service.py` に一本化（UI入口を少数に）。

## 8) 実行プラン（フェーズと作業単位）
- Phase 0: 境界ルール・集約ルールを文書化しレビュー基準化（本書）。
- Phase 1: UIから副作用を追い出す（DB/FS/OS を `database.py` / `file_ops.py` へ）。  
  - 作業単位: 副作用関数を1関数ずつ移動→UI呼び出し置換→スモーク。
- Phase 2: UIから判断ロジック・整形を追い出す（正規化、ソート、DTO整形）。  
  - 作業単位: ロジックを1関数ずつ `models.py` or `app_service.py` へ移動→UI薄化→スモーク。
- Phase 3: SQL集約（`database.py` に統合、呼び出しを `app_service` 経由に統一）。  
  - 作業単位: カテゴリ単位でSQL呼び出しを移設→対応表更新→スモーク。
- Phase 4: 不要ファイル削除・import整理・最終整頓。  
  - 作業単位: 不要ファイル/シンボル削除、UI→Core→Infra の一方向にimport整理→スモーク。

> 各作業単位は「関数単位で移動→動作確認→次へ」。移動対象/移動先/薄くしたUI内容を都度記録する。

## 9) 動作確認手順（安全網・手動最小）
1. `streamlit run streamlit_app.py` で起動。
2. 総動画数・総視聴回数が表示されること。
3. お気に入りレベル切替で該当数が変化すること。
4. 任意カードの「▶️ 再生」で例外が出ないこと。
5. 「ファイルをスキャン」「視聴履歴を検知」で例外が出ないこと。
6. 終了後ログに例外がないこと。
7. 各フェーズ完了ごとに上記を再実施し、ベースラインとの差分がないことを確認。

## 10) リスクと回避策
- import崩れ・循環依存: UI→Core→Infra の一方向に統一し、移動ごとにスモーク確認。
- DB接続箇所の取り残し: DB呼び出しをリスト化し、全て `database.py` 経由に差し替えたことを対応表で確認。
- 副作用の取り残し（OS起動/Path操作）: `file_ops.py` に集約した関数一覧を作り、UI直呼びを検索で確認。
- 挙動差分: 各フェーズ後に手動スモーク＋代表フィルタ×並び順のスナップショット比較。
- HTML/CSS分離の逸脱: 本フェーズでは実施しない。将来課題に記載し、現行挙動維持を優先。
