# ADR 001: ファイル識別に essential_filename を使う

**日付**: 2026-01-25
**状態**: 採用済み

---

## 背景

ClipBoxはお気に入りレベルをファイル名のプレフィックスで表現する（`###_作品.mp4`, `##_作品.mp4` 等）。
ユーザーがレベルを変更するたびにファイルがリネームされるため、フルパスや完全なファイル名では同一動画を追跡できない。
また、ドライブ間でファイルを移動することもある（Cドライブ ↔ 外付けHDD）。

---

## 決定

プレフィックス（`!`, `+`, `#`系）をすべて除去したファイル名を **essential_filename**（本質的ファイル名）として定義し、DBの主識別子（UNIQUE制約）とする。

```python
# 変換例
"!###_作品名.mp4"  →  essential_filename = "作品名.mp4"
"####_作品名.mp4"  →  essential_filename = "作品名.mp4"
"作品名.mp4"       →  essential_filename = "作品名.mp4"
```

`core/scanner.py` の `extract_essential_filename()` が変換を担当する。

---

## 却下した代替案

| 案 | 却下理由 |
|----|---------|
| フルパスで識別 | リネーム・移動のたびに同一動画が別レコードになる |
| ファイルサイズ + 更新日時のハッシュ | エンコード・再圧縮で変わる。計算コスト高。 |
| ファイル内容のハッシュ（MD5等） | 全ファイルの読み込みが必要。数GBファイルで非現実的。 |
| 数値IDをファイルに埋め込む | ファイルのバイナリ改変が必要。ユーザーが管理できない。 |

---

## トレードオフ

**許容した制約**:
- 同一ディレクトリに同名ファイル（プレフィックスのみ異なる）が複数存在すると衝突する。
  ただし ClipBox のユーザーがそのような状況を作ることは実用上ない。
- ファイル本体の内容が変わっても追跡が継続する（意図的な上書きも「同一動画」扱い）。
  ユーザーがファイルを置き換えた場合は手動でDB削除が必要。

**得たもの**:
- プレフィックス変更（判定）後も同一動画として視聴履歴が引き継がれる。
- ドライブ間移動後もスキャン1回で再リンクされる。
- `extract_essential_filename()` という単一関数でロジックを集約できる。
