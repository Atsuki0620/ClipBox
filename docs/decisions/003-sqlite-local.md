# ADR 003: ローカル SQLite を採用する

**日付**: 2026-01-25
**状態**: 採用済み

---

## 背景

ClipBoxは1ユーザーが1台のWindowsマシンで利用するデスクトップアプリケーション。
データベースの選択においてシンプルさと即時起動を重視する。

---

## 決定

**SQLite**（`data/videos.db`）をローカルに配置して使用する。

- Python標準ライブラリの `sqlite3` のみで動作
- インストール・設定・サーバー起動が不要
- `data/` ディレクトリにファイル1つで完結
- `get_db_connection()` コンテキストマネージャで接続を管理

---

## 却下した代替案

| 案 | 却下理由 |
|----|---------|
| PostgreSQL / MySQL | サーバーインストールが必要。1ユーザー用途に過剰。 |
| MongoDB | スキーマレスの柔軟性が不要。動画メタデータは構造が明確。 |
| JSON ファイル | クエリ・インデックスが使えない。数千件で遅くなる。 |
| Pandas + CSV | トランザクションがない。視聴履歴の並行書き込みに弱い。 |

---

## トレードオフ

**許容した制約**:
- 同時書き込みは `SQLITE_BUSY` が発生しやすい（対策: `auto_start_counters` に `conn` 引数を渡しネスト接続を排除）。
- WALモード未設定のため、読み書き同時アクセスで競合の可能性がある。
  ただし Streamlit はシングルユーザー前提のため実用上問題なし。
- ファイルが破損した場合はバックアップからの復元が必要（`create_backup()` で定期取得推奨）。

**得たもの**:
- 追加インストールなしで即起動。
- `data/videos.db` をコピーするだけでバックアップ・移行が完了。
- テストでは `tmp_path` に DB を置くだけでユニットテストが完結する。
- 将来の Flask/FastAPI 移行後も同じ DB ファイルを継続利用可能。
