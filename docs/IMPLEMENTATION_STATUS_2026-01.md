# ClipBox 実装ステータス・要件対応詳細（2026-01-02 現在）

> 目的: `docs/FEATURE_REQUIREMENTS_2026-01.md`（以下「要件書」）に書かれた計画と、現時点のコードがどう一致/不一致なのかを CodingAgent が一読で把握できるようにする。  
> 方針: 4 つの優先領域（判定 / カウンタ / データ管理 / UI 改善）ごとに「計画→実装→発生エラー→改善経緯→現在の状態」を時系列で詳述し、想定外事項も明記する。事実のみを記載し、推測は避ける。

---

## 0. 前提と全体構成
- 基準日時: 2026-01-02。確認対象はローカルリポジトリの `streamlit_app.py` ほか。
- 現行タブ構成: `📁 動画一覧` / `🎲 ランダム再生` / `📊 統計` / `🕰 最近見ていないお気に入り` / `📸 スナップショット` / `⚙️ 設定`。  
  - 廃止済みタブ: `📋 詳細一覧（標準）`・`カード一覧`・`グリッド一覧`（ユーザー決定で UI から除去）。
- プロトタイプ用 `ui_prototypes/` ディレクトリは物理的に残存するが、現行コードからは参照されていない。
- 優先順位（要件書どおり）: ①判定機能 > ②カウンタ機能 > ③データ管理機能 > ④UI改善。

---

## 1. 判定機能（最優先） ― 計画 / 実装 / エラー / 改善 / 現状
### 1.1 要件書の計画
- 星アイコンによる評価入力、判定ボタンでファイル名プレフィックスを `####_ / ###_ / ##_ / #_ / _` にリネームし、DB `current_favorite_level` を更新。  
- 成功時はメッセージ表示＋自動 rerun。失敗時はエラー表示（PermissionError, FileNotFound など）。  
- 全動画行に判定 UI を表示し、一括判定は提供しない。

### 1.2 現行実装
- UI: 星ではなく「数字ラジオ（4/3/2/1/0）＋色丸」を採用。判定ボタンあり。Lv バッジ表示は `Lv0-4`。  
- ロジック: `_handle_judgment` 関数が**定義されていない**ため、判定ボタンを押すと必ず NameError でクラッシュ。リネームも DB 更新も一切行われない。  
- エラーハンドリング: 実質未実装（呼び先がないため）。

### 1.3 発生したエラーと対処
- NameError: `_handle_judgment` 未定義 → 未解消のまま。  
- 影響: 判定ボタンがすべて機能停止。優先度トップの要件が未達。

### 1.4 途中で行った改善
- 画面密度向上のため評価 UI を星→数字化（ユーザー要望）。  
- バッジ化でレベルをコンパクト表示。  
- 余白削減（divider 削除、1〜6 列切替）により判定 UI を1画面に多く並べられるようにした。

### 1.5 現在の状態（まとめ）
- UIはあるが中身なし。判定処理・リネーム・DB更新・エラー処理をゼロから実装する必要がある。  
- 判定ボタンを押すと即例外→ユーザー体験を著しく損なうため、最優先で修正必須。

---

## 2. カウンタ機能（優先度2） ― 計画 / 実装 / エラー / 改善 / 現状
### 2.1 要件書の計画
- 固定 3 本のカウンタ（A/B/C）。viewing_history を対象にリアルタイム集計。  
- 初回再生で自動開始、リセットボタン（確認付き）、統計タブ上部に表示。  
- カウンタ名は固定、増減は再生検知時に自動、計算は SQL でシンプルに。

### 2.2 現行実装
- コード・DB・UIすべて**未実装**。カウンタ用テーブルや設定項目も存在しない。  
- 統計タブは従来の視聴回数ランキングのみ。

### 2.3 発生したエラー
- 直接の例外は無し（機能自体が存在しないため）。

### 2.4 改善経緯
- カウンタ関連の着手なし。UI再編（タブ削除・一覧集中）の流れの中で後回しになった。

### 2.5 現在の状態（まとめ）
- 要件書における機能ゴールに対し進捗 0%。  
- 追加設計（DBスキーマ、集計ロジック、UI表示、リセット動作）を新規で行う必要がある。

---

## 3. データ管理機能（優先度3） ― 計画 / 実装 / エラー / 改善 / 現状
### 3.1 要件書の計画
- 専用タブ「🗑 データ管理」で videos レコードの削除、CASCADE で関連履歴も削除。  
- 確認ダイアログ必須、フィルタ付与、一括削除は不要。  
- 削除は DB のみ（物理ファイルは残す）。

### 3.2 現行実装
- タブ自体が UI から除去されており、コードも未実装。  
- CASCADE 削除のロジック、確認 UI も存在しない。

### 3.3 発生したエラー
- 機能が存在しないため直接的な例外はなし。ただし要件未達。

### 3.4 改善経緯
- ユーザーの「一覧一本化」決定に伴い、データ管理タブも含めて削除された。  
- 以後、復活や代替案は検討されていない。

### 3.5 現在の状態（まとめ）
- 要件書の優先度③を満たしていない。  
- 削除 UI を提供するにはタブ復元＋DB 操作ロジックを新規開発する必要がある。

---

## 4. UI 改善（優先度4） ― 計画 / 実装 / エラー / 改善 / 現状
### 4.1 要件書の計画
- 新タブ「📋 詳細一覧」を追加し、カード/テーブル/コンパクト/グリッドの複数プロトタイプで検証。  
- 常時表示情報: タイトル、レベル、視聴回数、保存場所、アクション（判定・再生）。  
- 詳細情報の展開表示: 登場人物、フルパス、最終視聴日時、ファイルサイズ、更新日時。  
- ソート（視聴回数/最終視聴/タイトル/お気に入り）、検索（正規化部分一致）、視聴回数フィルタ、ページネーションなし、サムネなし。

### 4.2 現行実装
- タブ一本化: 「動画一覧」だけを残し、複数パターン UI は全削除。  
- 実装した要素  
  - 列数切替 1〜6、ソートセレクト、件数表示。  
  - バッジで Lv / 視聴回数 / 保存場所 / サイズ / 最終更新を常時表示。  
  - 星評価を廃止し数字＋色丸ラジオに変更。  
  - 余白圧縮（divider削除）、密度を上げて 20 件/画面を狙う。  
- 未実装の要素  
  - 検索入力（重複 key エラー後に撤去）。  
  - 視聴回数フィルタ（0回のみ、1回以下、5回以上など）。  
  - 詳細展開情報、テーブル/グリッド等の別パターン、新タブ。  
  - ボタン配色（明るいブルーへの変更）は未対応。

### 4.3 発生した主なエラーと対処
- StreamlitDuplicateElementKey（detail_search）: 検索入力キー重複 → 検索 UI を撤去。  
- Columns nesting error: container 内で columns を入れ子にしすぎ → ネスト1段に整理。  
- IndentationError: バッジ join 部分のインデント崩れ → 修正済み。  
- NameError `_normalize_text` / `_badge`: 定義位置をグローバルに移動して解消。

### 4.4 改善経緯
- 密度優先へ舵切り: 星評価表示や冗長テキストを排除し、バッジとタイトルだけで重要情報を示す。  
- 1〜6 列切替と余白削減で「たくさん表示したい」要望に対応。  
- ユーザー評価の結果、テーブル・コンパクト型等は不採用となり、一覧一本化を決定。

### 4.5 現在の状態（まとめ）
- UI 改善は「一覧一本化・バッジ化・多列化」までは完了。  
- 要件書にある検索、視聴回数フィルタ、詳細展開、別タブ検証は未達。  
- 配色・微細な余白調整は追加余地あり。

---

## 5. エラー発生史（時系列）
1) detail_search 重複キー → 検索 UI 撤去で解消。  
2) `_normalize_text` / `_badge` NameError → 定義をグローバルへ移動。  
3) columns nesting 例外 → ネストを1レベルに抑制。  
4) IndentationError（バッジ join）→ インデント修正。  
5) 自動検知による視聴履歴74件誤記録 → 起動時自動検知を停止し、サイドバー確認チェック付き実行に変更。  
6) `_handle_judgment` 未定義 → **未解消**（現行で最重要の未解決エラー）。

---

## 6. 現在残っている主なリスク
- 判定ボタンを押すと確実に例外が発生し、判定機能が使えない。  
- 要件優先度 2・3（カウンタ・データ管理）が手付かず。  
- 検索/フィルタ/詳細展開が無いため、要件書の「情報量を増やす」「探しやすくする」目的に一部反する。  
- バッジの文字色は黒固定で、背景色とのコントラストが環境に依存。  
- ページネーションなし・多列化による可読性低下の可能性（特に小画面）。

---

## 7. 今後の着手順（要件優先度に沿った推奨）
1) 判定機能を完成させる  
   - `_handle_judgment` を実装（プレフィックス置換リネーム + DB更新 + rerun + 例外処理）。  
   - エラーメッセージと成功メッセージを星→数字表記に合わせて調整。  
2) カウンタ機能を追加  
   - DB スキーマ追加（counters 等）、viewing_history 集計、リセット UI（確認付き）、統計タブ表示。  
3) データ管理タブを再導入または代替 UI で削除機能を提供  
   - CASCADE 削除、安全確認、フィルタ、成功/失敗通知。  
4) UI改善の残項目  
   - タイトル検索（正規化）、視聴回数フィルタ、詳細展開。  
   - ボタン配色・バッジ余白の微調整。必要なら `ui_prototypes` を明示的に廃止または再活用を決める。

---

## 8. 参照ファイル
- メイン: `streamlit_app.py`
- コア: `core/database.py`, `core/video_manager.py`, `core/scanner.py`, `core/history_repository.py`, `core/settings.py`
- 設定: `config.py`
- 要件書: `docs/FEATURE_REQUIREMENTS_2026-01.md`
- 本ドキュメント: `docs/IMPLEMENTATION_STATUS_2026-01.md`
- 未使用プロトタイプ: `ui_prototypes/`（現コード未参照）

---

本書は 2026-01-02 時点のコードと要件書を突き合わせて作成した。以降の変更が入った場合は本書を更新し、特に判定・カウンタ・データ管理の進捗を都度追記すること。疑問があればユーザーに確認し、優先順位に従って実装を進めてください。
