# ClipBox プロジェクト概要

---

## 1. プロジェクト概要

### 1.1 背景と目的

ClipBoxは、ローカル動画ファイルを効率的に管理するためのデスクトップアプリケーションです。

**解決する課題**:
- 複数のストレージ（Cドライブ、外付けHDD）に分散した動画ファイルの一元管理
- 視聴履歴の追跡と可視化
- お気に入り動画の評価とフィルタリング
- ファイル移動・リネーム後の追跡

**主要機能**:
- ディレクトリスキャンによる動画ファイル自動登録
- ファイル名プレフィックスによるお気に入りレベル管理
- アプリ内再生とワンクリック判定（評価）
- 視聴回数・視聴日時の記録と統計表示
- ランダム再生による未判定動画の効率的な消化

### 1.2 スコープ

**対象**:
- ローカルストレージ上の動画ファイル（`.mp4`, `.avi`, `.mkv`, `.mov`, `.wmv`, `.flv`, `.webm`）
- Windows環境での利用

**対象外**:
- ストリーミング動画
- クラウドストレージ上のファイル
- 動画の編集・変換機能

---

## 2. 開発状況

### 2.1 現在のフェーズ

**Phase 1: Streamlit UI 実装**（進行中）

Streamlitを使用したWebベースのUIを構築。将来的にFlask/FastAPIへの移行を視野に入れた設計。

### 2.2 実装済み機能

| カテゴリ | 機能 | 状態 |
|---------|------|------|
| スキャン | ディレクトリスキャン | ✅ 完了 |
| スキャン | ファイル利用可能性追跡 | ✅ 完了 |
| 再生 | 外部プレイヤー起動 | ✅ 完了 |
| 再生 | 視聴履歴自動記録 | ✅ 完了 |
| 判定 | お気に入りレベル設定 | ✅ 完了 |
| 判定 | ファイルリネーム（プレフィックス変更） | ✅ 完了 |
| 判定 | 判定中バッジ表示 | ✅ 完了 |
| セレクション | !プレフィックス動画の管理 | ✅ 完了 |
| UI | 動画一覧タブ | ✅ 完了 |
| UI | 未判定ランダムタブ | ✅ 完了 |
| UI | セレクションタブ | ✅ 完了 |
| UI | 分析タブ | ✅ 完了 |
| UI | 設定タブ | ✅ 完了 |
| UI | 検索タブ | ✅ 完了 |

### 2.3 現行タブ構成

```
📁 動画一覧      - フィルタリング可能な動画一覧
🎲 未判定ランダム - 未判定動画のランダム表示・判定
🔍 セレクション  - !プレフィックス動画の管理
🔎 検索          - ファイル名・出演者検索
📊 分析          - 視聴統計・カウンター・ランキング
⚙️ 設定          - アプリ設定・データベース管理
```

---

## 3. 技術スタック

### 3.1 フレームワークとライブラリ

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| UI | Streamlit | 1.30+ |
| データベース | SQLite | 3.x |
| データ処理 | Pandas | 2.x |
| 可視化 | Plotly, Matplotlib, Seaborn | - |
| 言語 | Python | 3.10+ |

### 3.2 アーキテクチャ方針

```
┌─────────────────────────────────────┐
│           UI層 (Streamlit)          │
│  streamlit_app.py, ui/*.py          │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│          Core層 (Python)            │
│  core/*.py                          │
│  ※ UIフレームワークに依存しない     │
└─────────────────┬───────────────────┘
                  │
┌─────────────────▼───────────────────┐
│          Data層 (SQLite)            │
│  data/videos.db                     │
└─────────────────────────────────────┘
```

**重要**: Core層では`st`（Streamlit）をインポートしない。これにより将来のFlask/FastAPI移行が容易になる。

---

## 4. ファイル命名規則とレベル定義

### 4.1 プレフィックスシステム

ファイル名の先頭にあるプレフィックスでお気に入りレベルを識別します。

| プレフィックス | レベル | 意味 | 表示 |
|--------------|--------|------|------|
| `####_` | 4 | 最高評価 | ★★★★ |
| `###_` | 3 | 高評価 | ★★★☆ |
| `##_` | 2 | 中評価 | ★★☆☆ |
| `#_` | 1 | 低評価 | ★☆☆☆ |
| `_` | 0 | 要削除候補 | ☆☆☆☆ |
| プレフィックスなし | -1 | 未判定 | - |

**特殊プレフィックス**:

| プレフィックス | 意味 |
|--------------|------|
| `!` | セレクション未選別（外付けHDDから選別待ち） |
| `+` | セレクション選別完了（ライブラリ取り込み済み） |

`!` と `+` はレベルプレフィックスと組み合わせ可能: `!###_作品.mp4`, `+##_作品.mp4`

### 4.2 変換例

```
# 未判定 → レベル3に判定
作品名.mp4  →  ###_作品名.mp4

# レベル2 → レベル4に変更
##_作品名.mp4  →  ####_作品名.mp4

# セレクション選別後
!作品名.mp4  →  ###_作品名.mp4  （レベル判定も同時に行う）
```

### 4.3 本質的ファイル名（essential_filename）

プレフィックス（!、+、#系）をすべて除去したファイル名を「本質的ファイル名」として管理します。

```
ファイル: !####_作品名.mp4
本質的ファイル名: 作品名.mp4
```

これにより、お気に入りレベル変更（プレフィックス変更）後も同一動画として追跡可能です。

---

## 5. 設定

### 5.1 アプリケーション設定（config.py）

| 設定名 | 値 | 説明 |
|--------|-----|------|
| `DATABASE_PATH` | `PROJECT_ROOT / "data" / "videos.db"` | SQLiteデータベースの場所 |
| `VIDEO_EXTENSIONS` | `.mp4`, `.avi`, `.mkv`, `.mov`, `.wmv`, `.flv`, `.webm` | サポートする動画形式 |
| `FILE_ACCESS_DETECTION_DAYS` | 1 | ファイルアクセス検知の閾値（日数） |
| `BACKUP_DIR` | `PROJECT_ROOT / "data" / "backups"` | バックアップ保存先 |
| `FAVORITE_LEVEL_NAMES` | -1: 未判定, 0-4: レベル0-4 | レベルの表示名 |

### 5.2 ユーザー設定（data/user_config.json）

ユーザー固有の設定を永続化するJSONファイル。`core/config_store.py`で管理。

| キー | 説明 |
|------|------|
| `library_roots` | スキャン対象ディレクトリのリスト |
| `default_player` | デフォルトの動画プレイヤー |
| `last_scan_time` | 最終スキャン日時 |

---

## 6. ビジネスルール

### 6.1 視聴履歴記録方式

視聴履歴は以下の3つの方法で記録されます（優先順位順）:

| 方式 | viewing_method | 説明 |
|------|---------------|------|
| アプリ再生 | `APP_PLAYBACK` | UIの再生ボタンクリックで即時記録 |
| ファイルアクセス検知 | `FILE_ACCESS_DETECTED` | ファイルアクセス時刻を定期スキャン → ユーザー確認後記録 |
| 手動エントリー | `MANUAL_ENTRY` | ユーザーが明示的に視聴済みとしてマーク |

### 6.2 判定フロー

```
1. 未判定動画の再生ボタンをクリック
   ↓
2. is_judging = 1 に更新（判定中バッジ表示）
   ↓
3. 外部プレイヤーで動画を視聴
   ↓
4. お気に入りレベルを選択
   ↓
5. 判定ボタンをクリック
   ↓
6. ファイルリネーム（プレフィックス変更）
   ↓
7. DB更新（current_favorite_level, is_judging = 0）
   ↓
8. 画面自動更新（st.rerun）
```

### 6.3 論理削除

`videos`テーブルには`is_deleted`フラグがあり、論理削除をサポートします。
クエリでは通常`is_deleted = 0`の条件を付けて、削除済みアイテムを除外します。

### 6.4 ファイル利用可能性

`is_available`フラグでファイルの存在状態を追跡します。
外付けHDDが未接続の場合など、ファイルが一時的に利用不可になるケースに対応。

**重要**: `scan_and_update()` の `is_available=0` 更新は、実際にスキャンしたディレクトリ配下のレコードのみに限定。未接続ドライブの動画を誤って `is_available=0` にしない設計。

---

## 7. バッジ仕様

動画カードに表示されるバッジの仕様です。

| バッジ | 条件 | 色コード | 用途 |
|--------|------|----------|------|
| 判定中 | `is_judging = 1` | #f59e0b（アンバー） | 再生後、判定待ちの動画 |
| 判定済み | `current_favorite_level >= 0` | #22c55e（緑） | 評価済みの動画 |
| 未判定 | `current_favorite_level = -1` | #f9a8d4（ピンク） | 未評価の動画 |
| 未選別 | `needs_selection = 1` | #818cf8（インディゴ） | !プレフィックス動画 |

---

## 8. 将来の移行計画

### Phase 2: Flask/FastAPI移行

- Core層は既にUIに依存しないため再利用可能
- `streamlit_app.py`と`ui/`ディレクトリのみ書き直し
- REST API + Reactフロントエンドへの移行を想定

### 計画中の機能

- サムネイル表示
- 気分タグ
- プレイリスト
- ML推薦

---

## 9. 日本語サポート

- UIとドキュメントは日本語
- ファイルパスには日本語文字が含まれる可能性がある（OneDriveパスなど）
- すべてのテキスト操作にUTF-8エンコーディングを使用
- データベースはUnicodeストレージを使用（SQLiteのTEXT型）
