# ClipBox 改善仕様書
**作成日**: 2026-01-24
**バージョン**: 1.0

---

## 概要

ClipBoxは動画ファイル管理システムです。本仕様書では、未判定動画の評価作業を効率化するための改善項目を定義します。

---

## 改善項目一覧

### 優先度別サマリー

| 優先度 | ID | 項目名 | 種別 |
|--------|-----|--------|------|
| 最優先 | P1 | クリック時の画面更新もたつき改善 | パフォーマンス |
| 最優先 | B1 | 起動直後にコードが表示されるバグ | バグ |
| 最優先 | B2 | シャッフル時に表示設定がリセットされる | バグ |
| 高 | U1 | 動画カード内ボタンのはみ出し修正 | UI |
| 高 | U2 | 表示設定内のカラム数スライダー削除 | UI |
| 中 | F4 | 判定中バッジ（ステートフル） | 新機能 |
| 中 | F3 | 判定済みバッジ | 新機能 |
| 中 | F1 | デフォルト表示項目の追加 | 新機能 |
| 中 | F2 | 表示設定に「作成日時」を追加 | 新機能 |
| 低 | U3 | 視聴回数ランキング表示件数をラジオボタン化 | UI |

---

## 詳細仕様

### P1: クリック時の画面更新もたつき改善

**現状の問題**:
- あらゆるボタンクリック、プルダウン選択時に画面が約1秒読み込まれる
- 特にレベルプルダウン選択→判定ボタン押下の連続操作で顕著

**原因分析**:
- `st.rerun()`が全操作後に呼び出され、ページ全体が再実行される
- 該当箇所: `streamlit_app.py` 行102, 120

**改善目標**:
- 0.1〜0.3秒以内の反応速度
- 実装が容易でバグを発生しにくい方を優先

**対象範囲**:
- 全タブ・全操作

**技術的アプローチ**:
1. `@st.cache_data`でデータ取得をキャッシュ
2. `st.fragment`（Streamlit 1.33+）で部分更新
3. 不要な`st.rerun()`の削除

---

### B1: 起動直後にコードが表示されるバグ

**現状の問題**:
- アプリ起動直後に`python archive/setup_db.py`というコードが表示される

**原因**:
- `streamlit_app.py` 行166の`st.code()`呼び出し
- `check_and_init_database()`内でDBエラー時に表示

**修正方針**:
- 該当の`st.code()`を削除または条件付きに変更

---

### B2: シャッフル時に表示設定がリセットされるバグ

**現状の問題**:
- 未判定ランダムタブでシャッフルすると表示設定がデフォルトにリセット

**原因**:
- `st.rerun()`でウィジェット状態がリセットされる
- 該当箇所: `ui/unrated_random_tab.py` 行77

**修正方針**:
- 表示設定をセッション状態に永続化
- `st.rerun()`後も設定を復元

---

### U1: 動画カード内ボタンのはみ出し修正

**現状の問題**:
- ボタン内の文字やアイコンが横にはみ出している

**原因**:
- カラム幅比率`[2, 2, 4, 8]`が狭い
- 該当箇所: `ui/components/video_card.py` 行236

**修正方針**:
- カラム幅を調整してはみ出しを解消
- ボタン表示をアイコンのみに統一（▶️、✓ など）
- CSS調整でオーバーフロー防止

**対象**:
- 動画一覧タブ
- 未判定ランダムタブ

---

### U2: 表示設定内のカラム数スライダー削除

**理由**:
- 外側にラジオボタンでカラム数設定があるため重複

**対象**:
- 動画一覧タブ
- 未判定ランダムタブ

**該当ファイル**:
- `ui/components/display_settings.py` 行59-65

---

### F4: 判定中バッジ（ステートフル）

**仕様**:
1. 未判定動画の再生ボタン押下 → [判定中]バッジ付与
2. レベルプルダウンで評価選択
3. 判定ボタン押下 → [判定中]バッジ解除 + [判定済み]バッジ付与
4. **アプリ再起動後も判定中状態を維持**

**実装方式**: DB保存

**データベース変更**:
```sql
ALTER TABLE videos ADD COLUMN is_judging BOOLEAN DEFAULT 0;
```

**対象**:
- 未判定ランダムタブ

**バッジ仕様**:
- 色: アンバー/オレンジ系（#f59e0b）
- テキスト: 「判定中」
- 位置: カード下部（ボタンの下の行）

---

### F3: 判定済みバッジ

**条件**:
- `current_favorite_level >= 0` の動画に表示

**バッジ仕様**:
- 色: 緑（#22c55e）
- テキスト: 「判定済み」

**対象**:
- 動画一覧タブ
- 未判定ランダムタブ

---

### F1: デフォルト表示項目の追加

**現在のデフォルトON項目**:
- ファイル名
- 視聴回数
- 作成日
- お気に入りレベル

**対象**:
- 動画一覧タブ
- 未判定ランダムタブ

---

### F2: 表示設定に「作成日時」を追加

**内容**:
- 表示設定のチェックボックスに「作成日時」オプション追加

**対象**:
- 動画一覧タブ
- 未判定ランダムタブ

---

### U3: 視聴回数ランキング表示件数をラジオボタン化

**対象**:
- 統計・分析タブ

**要望**:
- TopN設定をラジオボタンで選択（例: 10, 20, 50, 100）

---

## バッジ表示仕様

### 表示位置
- カード下部（ボタンの下の行）

### 複数バッジがある場合
- 横並びで表示（例: `[判定中] [判定済み]`）

### バッジの種類と色
| バッジ | 条件 | 色 |
|--------|------|-----|
| 判定中 | `is_judging = 1` | #f59e0b（アンバー） |
| 判定済み | `current_favorite_level >= 0` | #22c55e（緑） |
| 未判定 | `current_favorite_level = -1` | #f9a8d4（ピンク） |

---

## 共通コンポーネント適用範囲

以下は`ui/components/video_card.py`で実装されているため、修正すれば両タブに同時適用:
- P1（カード内操作のもたつき）
- U1（ボタンはみ出し）
- F1（デフォルト表示項目）
- F2（作成日時表示）
- F3（判定済みバッジ）
- F4（判定中バッジ）

---

## 実装フェーズ

### フェーズ1: パフォーマンス・バグ修正
1. P1: クリック時のもたつき改善
2. B1: 起動時コード表示バグ
3. B2: シャッフル時の設定リセット

### フェーズ2: UI改善
4. U1: ボタンはみ出し修正
5. U2: カラム数スライダー削除

### フェーズ3: 新機能
6. F4: 判定中バッジ（DB変更含む）
7. F3: 判定済みバッジ
8. F1: デフォルト表示項目
9. F2: 作成日時表示

### フェーズ4: 細かい改善
10. U3: ランキングのラジオボタン化

---

## 実装時の注意事項

1. **レイヤー分離の維持**: UI層、Core層、Data層の分離を保つ
2. **段階的実装**: 各フェーズごとに動作確認
3. **バグを発生させない**: 実装容易な方法を優先
4. **既存機能の保持**: 現在動いている機能を壊さない
