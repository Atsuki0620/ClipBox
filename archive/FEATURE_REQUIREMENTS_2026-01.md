# ClipBox 機能追加要件定義書

**作成日**: 2026-01-02
**対象バージョン**: v0.2.0
**優先順位**: ①判定機能 → ③カウンタ機能 → ④データ管理機能 → ②UI改善
**策定プロセス**: 質疑応答による段階的要件定義（詳細は[セクション12](#12-質疑応答記録)参照）

---

## 目次

1. [概要](#1-概要)
2. [①判定機能（最優先）](#2-判定機能最優先)
3. [③カウンタ機能](#3-カウンタ機能)
4. [④データ管理機能](#4-データ管理機能)
5. [②UI改善](#5-ui改善)
6. [データベース設計](#6-データベース設計)
7. [実装順序と依存関係](#7-実装順序と依存関係)
8. [テスト項目](#8-テスト項目)
9. [注意事項とリスク](#9-注意事項とリスク)
10. [実装チェックリスト](#10-実装チェックリスト)
11. [参考資料](#11-参考資料)
12. [質疑応答記録](#12-質疑応答記録)

---

## 1. 概要

### 1.1 背景

現行のClipBoxシステムでは、以下の課題がある：

1. 視聴後の評価（お気に入りレベル変更）がファイル名の手動リネームに依存
2. 動画一覧の表示が見にくく、視聴回数などの重要情報が不足 **[Q2-1]**
3. 特定期間の視聴傾向を測定する仕組みがない **[Q3-1]**
4. DBに不要なレコードが蓄積しても削除手段がない

### 1.2 目的

本機能追加により、以下を実現する：

1. **判定機能**: アプリ内で視聴後の評価を即座に反映（ファイルリネーム自動化）
2. **カウンタ機能**: 複数の独立したカウンタで特定期間の視聴傾向を測定
3. **データ管理機能**: 不要なDBレコードを安全に削除
4. **UI改善**: 視聴回数等の情報を追加し、見やすい一覧表示を実現

### 1.3 実装方針

- **実装難易度**: 中程度（複雑すぎる実装は避ける） **[Q3-10]**
- **後方互換性**: 既存機能を維持し、新機能を追加
- **エラーハンドリング**: ファイル操作失敗時は安全にロールバック **[Q1-9]**
- **自動マイグレーション**: アプリ起動時に新テーブルを自動追加 **[Q6-1]**

---

## 2. 判定機能（最優先）

### 2.1 機能概要 **[Q1-1, Q1-2]**

**目的**: アプリ経由で視聴した動画に対し、視聴後すぐに評価（お気に入りレベル）を変更できるようにする。

**動作フロー** **[Q1-7, Q1-14]**:
```
1. ユーザーが動画一覧で評価を選択（星ボタン）
2. 「判定」ボタンをクリック
3. 物理ファイル名をリネーム（例: "作品名.mp4" → "###_作品名.mp4"）
4. DB上の current_full_path, current_favorite_level を更新
5. 成功メッセージ表示 + 画面自動更新（st.rerun）
```

### 2.2 詳細仕様

#### 2.2.1 お気に入りレベル定義 **[Q1-5, Q1-6]**

| レベル | プレフィックス | 意味 | 表示 |
|--------|---------------|------|------|
| 4 | `####_` | 最高評価 | ★★★★ |
| 3 | `###_` | 高評価 | ★★★☆ |
| 2 | `##_` | 中評価 | ★★☆☆ |
| 1 | `#_` | 低評価 | ★☆☆☆ |
| 0 | `_` | 要削除候補 | ☆☆☆☆ |

**重要決定事項**:
- レベル5（`#####_`）は不要（レベル4が最高） **[Q1-6]**
- 「`_`」はレベル0を明示的にマークする **[Q1-6]**
- 現在のお気に入りレベルシステムと統合 **[Q1-4]**

#### 2.2.2 UI配置 **[Q1-1, Q1-14]**

動画一覧の各行に以下を追加：

```
┌────────────────────────────────────────────────────────────┐
│ [タイトル]  [メタ情報]  [★★★☆] [判定] [再生]              │
└────────────────────────────────────────────────────────────┘
```

**星評価UI** **[Q1-7, Q1-12, Q1-16]**:
- Streamlit標準コンポーネントまたはボタン形式で実装
- シンプルなボタン形式（「★★★★ (4)」「★★★ (3)」など）も許容
- 星をホバーしてプレビュー → クリックで確定 **[Q1-12]**
- 既存のお気に入りレベルを初期表示 **[Q1-13]**
  - 例: `##_作品名.mp4` → 初期状態で ★★☆☆ を表示

#### 2.2.3 リネーム処理 **[Q1-3, Q1-8, Q1-18]**

**ケース1: プレフィックスなし → レベル追加** **[Q1-8]**
```
例: "作品名.mp4" → レベル3に判定
物理ファイル: "作品名.mp4" → "###_作品名.mp4"
DB更新:
  - current_full_path: "/path/to/###_作品名.mp4"
  - current_favorite_level: 3
  - essential_filename: "作品名.mp4" (変更なし)
```

**ケース2: 既存プレフィックス → レベル変更** **[Q1-8]**
```
例: "##_作品名.mp4" → レベル3に変更
物理ファイル: "##_作品名.mp4" → "###_作品名.mp4"
DB更新:
  - current_full_path: "/path/to/###_作品名.mp4"
  - current_favorite_level: 2 → 3
  - essential_filename: "作品名.mp4" (変更なし)
```

**ケース3: プレフィックス削除（レベル0選択時）**
```
例: "###_作品名.mp4" → レベル0に変更
物理ファイル: "###_作品名.mp4" → "_作品名.mp4"
DB更新:
  - current_full_path: "/path/to/_作品名.mp4"
  - current_favorite_level: 3 → 0
  - essential_filename: "作品名.mp4" (変更なし)
```

**重要決定事項** **[Q1-18]**:
- `essential_filename` は常に本質名（プレフィックスなしの名前）を保持する
- 実際のファイル名を物理的にリネームする **[Q1-3]**
- DB上の表示名も併せて変更する **[Q1-3]**

#### 2.2.4 エラーハンドリング **[Q1-9, Q1-17]**

リネーム失敗時の対応：

| エラー種別 | 検出方法 | 表示メッセージ | DB更新 |
|-----------|---------|---------------|--------|
| ファイル不存在 | `Path.exists()` | ファイルが見つかりません | しない |
| ファイル使用中 | `PermissionError` | ファイルが使用中です。プレイヤーを閉じてください | しない |
| OneDrive同期中 | `PermissionError` | OneDrive同期中のため失敗しました。しばらく待ってから再試行してください | しない |
| アクセス権限なし | `PermissionError` | ファイルへのアクセス権限がありません | しない |
| その他 | 例外全般 | リネームに失敗しました: {エラー詳細} | しない |

**処理方針** **[Q1-9]**:
- リネーム失敗時はエラー表示して、DB更新もキャンセルする

**処理フロー**:
```python
try:
    # 1. ファイル存在確認
    if not old_path.exists():
        raise FileNotFoundError

    # 2. リネーム実行
    old_path.rename(new_path)

    # 3. DB更新
    update_database(video_id, new_path, new_level)

    # 4. 成功メッセージ
    st.success(f"判定完了: {new_level_name}に変更しました")
    st.rerun()

except PermissionError:
    st.error("ファイルが使用中です...")
except Exception as e:
    st.error(f"リネームに失敗しました: {e}")
```

#### 2.2.5 判定後の処理 **[Q1-10, Q1-15, Q1-19]**

- 成功時: `st.success` でメッセージ表示 → `st.rerun()` で画面自動更新 **[Q1-19修正]**
  - 当初は手動更新予定だったが、自動更新に変更
- 失敗時: `st.error` でエラー表示、画面更新なし（再試行可能）
- スキャン: 手動スキャンボタンを押すまで実行しない **[Q1-10]**

#### 2.2.6 対象範囲 **[Q1-11, Q1-21]**

- **全ての動画に判定ボタンを表示** **[Q1-21]**
  - 既にプレフィックスがある動画も変更可能
  - フィルタ条件で絞り込んだ動画も含め、一覧に表示される全動画が対象

#### 2.2.7 制約事項 **[Q1-11, Q1-20]**

- 判定履歴（監査ログ）は記録しない **[Q1-20]**
- 一括判定機能は提供しない（1件ずつ判定） **[Q1-11]**
- 判定実行には確認ダイアログを表示しない（即座に実行）

---

## 3. カウンタ機能

### 3.1 機能概要 **[Q3-1]**

**目的**: 特定期間の視聴傾向を測定するため、複数の独立したカウンタを提供する。

**利用シーン** **[Q3-1]**:
- 「今日からの視聴回数をカウントしたい」と思ったときに設定可能
- 3つとも同様にカウントしていき、独立してリセット可能
- カウンタごとにいつからカウント開始しているのか表示

**動作イメージ**: 自動車の走行距離メーター（Trip A/B/C）のように、必要に応じてリセットしながら使い分ける。

### 3.2 詳細仕様

#### 3.2.1 カウンタ数と名前 **[Q3-2, Q3-3]**

- **固定3つ**: カウンタA、カウンタB、カウンタC **[Q3-2]**
- 名前は固定（ユーザーによる変更不可） **[Q3-3]**
- 追加・削除不可

#### 3.2.2 カウント対象 **[Q3-4]**

- **すべての `viewing_history`** をカウント対象とする **[Q3-4]**
  - APP_PLAYBACK（アプリ経由の再生）
  - FILE_ACCESS_DETECTED（ファイルアクセス検知）
  - MANUAL_ENTRY（手動記録、未使用だが将来対応）

#### 3.2.3 カウントタイミング **[Q3-5, Q3-14, Q3-15]**

**初回視聴時に自動開始** **[Q3-15]**:
```
状態: 全カウンタが「未使用」
  カウンタA: 0回（未使用）
  カウンタB: 0回（未使用）
  カウンタC: 0回（未使用）

↓ 任意の動画を1回視聴

状態: 全カウンタが同時に開始
  カウンタA: 1回（2026-01-02 10:00 から）
  カウンタB: 1回（2026-01-02 10:00 から）
  カウンタC: 1回（2026-01-02 10:00 から）
```

**視聴時の動作** **[Q3-14]**:
- 1回の視聴で、**3つ全てのカウンタが同時にカウントアップ**
- ユーザーによる選択不要（自動的に全カウンタ加算）
- 再生時に自動的にカウント **[Q3-5]**

#### 3.2.4 カウンタの計算方法 **[Q3-10, Q3-11]**

**リアルタイムSQL集計**（実装難易度: 低） **[Q3-10]**:

```sql
-- カウンタAの値を取得
SELECT COUNT(*)
FROM viewing_history
WHERE viewed_at >= (SELECT start_time FROM counters WHERE counter_id = 'A')
```

**選定理由**:
- 実装がシンプル（実装難易度を抑える要求に適合）
- viewing_history の修正（手動削除等）に自動追従

**制約** **[Q6-2]**:
- カウンタ設定（開始日時）**以降**の viewing_history のみカウント
- 過去の履歴を遡ってカウントしない

#### 3.2.5 リセット機能 **[Q3-6, Q3-9, Q3-16]**

**リセット操作** **[Q3-6]**:
```
1. 統計タブでカウンタAの「リセット」ボタンをクリック
2. 確認ダイアログ表示: "カウンタAをリセットしますか？"
3. 「はい」を選択
4. リセット実行:
   - 開始日時を現在時刻に更新
   - カウント値は自動的に0になる（SQL集計のため）
```

**リセット前後の状態** **[Q3-9, Q3-16]**:
```
リセット前: カウンタA: 125回（2026-01-02 10:00 から）
リセット後: カウンタA: 0回（2026-01-03 14:00 から）← 自動的に再開
```

**重要決定事項** **[Q3-16]**:
- リセット = ゼロ化 + 即座に再開（停止状態にはならない）

#### 3.2.6 表示仕様 **[Q3-7, Q3-8, Q3-12, Q3-13]**

**表示場所**: 統計タブの上部 **[Q3-7, Q3-12]**

**表示形式** **[Q3-8]**:
```
┌─────────────────────────────────────────────┐
│ 📊 統計                                      │
├─────────────────────────────────────────────┤
│ ┌───────────────────────────────────────┐  │
│ │ カウンタ                               │  │
│ │ カウンタA: 125回（2026-01-02 10:00 から）│  │
│ │ [リセット]                             │  │
│ │                                        │  │
│ │ カウンタB: 45回（2025-12-25 15:30 から） │  │
│ │ [リセット]                             │  │
│ │                                        │  │
│ │ カウンタC: 0回（未使用）                │  │
│ │ [リセット]                             │  │
│ └───────────────────────────────────────┘  │
├─────────────────────────────────────────────┤
│ 視聴回数ランキング（全件）                   │
│ （既存の統計表示）                          │
└─────────────────────────────────────────────┘
```

**日時表示形式** **[Q3-13]**: `YYYY-MM-DD HH:MM`（分まで表示、秒は非表示）

**未使用状態の表示**: `0回（未使用）`

#### 3.2.7 データ保存 **[Q3-11]**

**新テーブル `counters` を作成** **[Q3-11]**:

```sql
CREATE TABLE IF NOT EXISTS counters (
    counter_id TEXT PRIMARY KEY,  -- 'A', 'B', 'C'
    start_time DATETIME,          -- カウント開始日時（NULL = 未使用）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 初期データ挿入
INSERT INTO counters (counter_id, start_time) VALUES
    ('A', NULL),
    ('B', NULL),
    ('C', NULL);
```

#### 3.2.8 制約事項

- カウンタ設定（開始日時）**以降**の viewing_history のみカウント **[Q6-2]**
- リセット履歴は保存しない
- カウンタごとの個別停止機能はなし（全カウンタが常時動作）

---

## 4. データ管理機能

### 4.1 機能概要 **[Q4-1, Q4-2]**

**目的**: DB上の不要な動画レコードを安全に削除する。

**対象** **[Q4-1]**: `videos` テーブルのレコード（物理ファイルは削除しない）

**削除範囲** **[Q4-4]**: CASCADE削除により、関連する `viewing_history` と `play_history` も同時削除

### 4.2 詳細仕様

#### 4.2.1 専用タブ追加 **[Q4-2, Q4-5]**

**タブ名** **[Q4-5]**: `🗑️ データ管理`

**タブ構成** **[Q4-5]**:
```
┌──────────────────────────────────────────┐
│ 🗑️ データ管理                            │
├──────────────────────────────────────────┤
│ フィルタ・検索                            │
│ ┌────────────────────────────────────┐  │
│ │ タイトル検索: [____________]       │  │
│ │ お気に入り: [全て ▼]              │  │
│ │ 視聴回数: [全て ▼]                │  │
│ │              [検索]                │  │
│ └────────────────────────────────────┘  │
├──────────────────────────────────────────┤
│ 検索結果: 25件                            │
│ ┌────────────────────────────────────┐  │
│ │ タイトル         | 視聴 | アクション │  │
│ │ 作品A.mp4        | 0回  | [削除]    │  │
│ │ 作品B.mp4        | 3回  | [削除]    │  │
│ │ ...                                │  │
│ └────────────────────────────────────┘  │
└──────────────────────────────────────────┘
```

#### 4.2.2 検索・フィルタ機能 **[Q4-6, Q2-14]**

**タイトル検索** **[Q2-14]**:
- 部分一致検索（大文字小文字、全角半角、カタカナひらがなを区別しない）
- 実装: Python側で正規化してマッチング
  ```python
  def normalize_text(text):
      import unicodedata
      # NFKCで全角半角統一、小文字化、ひらがなカタカナ統一
      text = unicodedata.normalize('NFKC', text)
      text = text.lower()
      # カタカナをひらがなに変換
      text = jaconv.kata2hira(text)  # または手動実装
      return text
  ```

**お気に入りレベルフィルタ** **[Q4-6]**:
- ドロップダウン選択: `全て`, `レベル4`, `レベル3`, `レベル2`, `レベル1`, `レベル0`, `プレフィックスなし`

**視聴回数フィルタ** **[Q4-6]**:
- ドロップダウン選択: `全て`, `0回のみ`, `1回以下`, `5回以上`, `10回以上`

#### 4.2.3 削除処理 **[Q4-3, Q4-4, Q4-9]**

**削除フロー** **[Q4-3]**:
```
1. 削除ボタンをクリック
2. 確認ダイアログ表示:
   "「作品A.mp4」を削除しますか？
    関連する視聴履歴（3件）も削除されます。"
3. 「はい」を選択
4. DB削除実行（CASCADE）
5. 成功メッセージ表示: "削除しました"
```

**SQL実行** **[Q4-4]**:
```sql
-- CASCADE削除（viewing_history, play_history も自動削除）
DELETE FROM videos WHERE id = ?;
```

**物理ファイルの扱い** **[Q4-1, Q4-9]**:
- **物理ファイルは削除しない**（DBレコードのみ削除）
- ファイル自体はOSのファイルシステムに残る
- 次回スキャン時に再登録される可能性あり（意図的な再登録防止は考慮しない）

**安全装置** **[Q4-9]**:
- 削除は即座に実行（物理削除）
- 論理削除（削除フラグ）は使用しない

#### 4.2.4 削除後の動作 **[Q4-7]**

- 成功メッセージ表示: `st.success("削除しました")` **[Q4-7]**
- **画面更新なし**（rerun不要）

#### 4.2.5 制約事項 **[Q4-8]**

- 一括削除機能なし（1件ずつ削除） **[Q4-8]**
- 削除の取り消し機能なし（即座に物理削除）
- 削除ログ・履歴の記録なし

---

## 5. UI改善

### 5.1 機能概要 **[Q2-1, Q2-3, Q2-13, Q5-2]**

**目的**: 動画一覧の視認性と情報量を改善し、効率的な動画管理を実現する。

**不満点** **[Q2-1]**:
- 重要な情報が見つけにくい
- レイアウトが窮屈
- 色やコントラストの問題
- スクロールせずにたくさんの動画情報を表示させたい
- 統計タブで表示している視聴回数も表示させたい

**アプローチ** **[Q5-2]**:
1. `ui_prototypes/` ディレクトリで複数のUIパターンを作成
2. ユーザーが最適なパターンを選択
3. 選択されたUIを新タブ「📋 詳細一覧」として追加（既存タブは残す） **[Q2-13]**

### 5.2 表示情報

#### 5.2.1 優先度の高い情報（常時表示） **[Q2-2, Q2-10, Q2-11]**

| 項目 | 表示内容 | 例 | 根拠 |
|------|---------|---|------|
| タイトル | essential_filename | `作品名.mp4` | Q2-2 |
| お気に入りレベル | 星マーク表示 | `★★★☆` | Q2-2 |
| 視聴回数 | 数値のみ | `5回` | Q2-2, Q2-6 |
| 保存場所 | Cドライブ/外付けHDD | `Cドライブ` | Q2-2 |
| アクション | 星評価、判定、再生ボタン | `[★★★☆] [判定] [再生]` | Q2-11 |

#### 5.2.2 詳細情報（展開式） **[Q2-5, Q2-10, Q2-11]**

| 項目 | 表示内容 | 例 | 根拠 |
|------|---------|---|------|
| 登場人物 | performer | `山田太郎` | Q2-5 |
| ファイルパス | current_full_path（フルパス） | `C:\Videos\###_作品名.mp4` | Q2-5 |
| 最終視聴日時 | 最新の viewing_history.viewed_at | `2026-01-02 15:30` | Q2-5 |
| ファイルサイズ | file_size | `1.2 GB` | - |
| 最終更新日時 | last_file_modified | `2025-12-25 10:00` | - |

#### 5.2.3 表示方法 **[Q2-10, Q2-11]**

**コンパクト表示 + 展開式** **[Q2-10]**:
```
┌────────────────────────────────────────────┐
│ ★★★☆ 作品名.mp4                           │
│ 5回 | Cドライブ  [▼詳細] [★★★☆] [判定] [再生] │
├────────────────────────────────────────────┤  ← 展開後
│ 登場人物: 山田太郎                          │
│ パス: C:\Videos\###_作品名.mp4             │
│ 最終視聴: 2026-01-02 15:30                 │
└────────────────────────────────────────────┘
```

### 5.3 追加機能

#### 5.3.1 ソート機能 **[Q2-7, Q2-12]**

**ソート対象列** **[Q2-7]**:
- 視聴回数（降順/昇順）
- 最終視聴日時（新しい順/古い順）
- タイトル（あいうえお順/逆順）
- お気に入りレベル（高い順/低い順）

**実装**:
- ドロップダウンまたはカラムヘッダークリックで切り替え
- セッション中のみ保持（ブラウザ更新で初期化） **[Q2-12]**

#### 5.3.2 タイトル検索 **[Q2-8, Q2-14]**

**検索方式** **[Q2-14]**: 部分一致（大文字小文字、全角半角、カタカナひらがな区別なし）

**実装**:
```python
st.text_input("タイトル検索", key="title_search")

# 正規化して検索
search_term = normalize_text(st.session_state.title_search)
filtered_videos = [v for v in videos if search_term in normalize_text(v.essential_filename)]
```

#### 5.3.3 視聴回数範囲フィルタ **[Q2-8]**

**フィルタオプション** **[Q2-8]**:
- 全て
- 0回のみ
- 1回以下
- 5回以上
- 10回以上

**実装**: サイドバーまたはタブ内にドロップダウン配置

### 5.4 UIプロトタイプ開発

#### 5.4.1 開発ディレクトリ **[Q5-2]**

```
ClipBox/
├── ui_prototypes/          ← 新規作成
│   ├── pattern_card.py     ← カード型レイアウト
│   ├── pattern_table.py    ← テーブル型レイアウト
│   ├── pattern_compact.py  ← コンパクトリスト型
│   ├── pattern_grid.py     ← グリッド型
│   └── test_data.py        ← 架空のテストデータ生成
```

#### 5.4.2 プロトタイプパターン **[Q2-3, Q2-15]**

以下のパターンを作成予定 **[Q2-3: すべて見てみたい]**:

1. **カード型**: 1動画1枚のカード、視覚的に見やすい
2. **テーブル型**: DataFrame形式、情報量多い
3. **コンパクトリスト型**: 現状の改良版、密度高い
4. **グリッド型**: サムネイル風、視覚的

パターン数: お任せ **[Q2-15]**

#### 5.4.3 テストデータ

架空の動画情報（100件程度）を生成し、各プロトタイプで表示テスト **[Q2-4: 100件以上]**。

### 5.5 本番適用

#### 5.5.1 新タブ追加 **[Q2-13]**

選択されたUIパターンを `streamlit_app.py` の新タブ「📋 詳細一覧」として追加。

**タブ構成（変更後）**:
```python
tab1, tab2, tab3, tab4, tab5, tab6, tab7 = st.tabs([
    "📁 動画一覧",           # 既存（残す）
    "📋 詳細一覧",           # 新規追加
    "🎲 ランダム再生",
    "📊 統計",
    "🕰 最近見ていないお気に入り",
    "📸 スナップショット",
    "🗑️ データ管理",         # 新規追加
    "⚙️ 設定",
])
```

#### 5.5.2 既存タブの扱い **[Q2-13]**

- 既存の「📁 動画一覧」タブは削除せず残す
- ユーザーが後で削除指示する可能性あり

### 5.6 制約事項 **[Q2-9]**

- ページネーション機能なし（全件スクロール表示） **[Q2-9]**
- サムネイル画像表示なし（ファイルパスのみ）
- ソート順の永続化なし（セッション中のみ保持） **[Q2-12]**

---

## 6. データベース設計

### 6.1 新規テーブル

#### 6.1.1 counters テーブル **[Q3-11]**

```sql
CREATE TABLE IF NOT EXISTS counters (
    counter_id TEXT PRIMARY KEY,           -- 'A', 'B', 'C'
    start_time DATETIME,                   -- カウント開始日時（NULL = 未使用）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 初期データ
INSERT INTO counters (counter_id, start_time) VALUES
    ('A', NULL),
    ('B', NULL),
    ('C', NULL)
ON CONFLICT(counter_id) DO NOTHING;  -- 既存データがあれば無視
```

**カラム説明**:
- `counter_id`: カウンタ識別子（A/B/C固定）
- `start_time`: カウント開始日時（NULLは未使用状態）
- `created_at`: レコード作成日時
- `updated_at`: 最終更新日時（リセット時に更新）

### 6.2 既存テーブルの変更

既存テーブル（`videos`, `viewing_history`, `play_history`）に変更なし。

### 6.3 マイグレーション **[Q6-1]**

#### 6.3.1 自動マイグレーション **[Q6-1]**

`core/database.py` の `init_database()` に新テーブル作成を追加：

```python
def init_database():
    """データベースとテーブルを初期化"""
    conn = sqlite3.connect(DATABASE_PATH)

    # 既存テーブル作成（省略）

    # 新規: counters テーブル作成
    conn.execute("""
        CREATE TABLE IF NOT EXISTS counters (
            counter_id TEXT PRIMARY KEY,
            start_time DATETIME,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    """)

    # 初期データ挿入
    conn.execute("""
        INSERT OR IGNORE INTO counters (counter_id, start_time) VALUES
            ('A', NULL),
            ('B', NULL),
            ('C', NULL)
    """)

    conn.commit()
    conn.close()
```

#### 6.3.2 実行タイミング

- アプリ起動時に自動実行（`streamlit_app.py` の `check_and_init_database()`）
- ユーザーの手動操作不要

---

## 7. 実装順序と依存関係

### 7.1 実装フェーズ **[Q5-1]**

優先順位: **①→③→④→②** **[Q5-1]**

#### フェーズ1: ①判定機能（最優先）

**実装順序**:
1. UI追加（星評価ボタン + 判定ボタン）
2. リネーム処理実装
3. DB更新処理
4. エラーハンドリング
5. 動作確認テスト

**所要時間**: 3-4時間

**依存**: なし

---

#### フェーズ2: ③カウンタ機能

**実装順序**:
1. `counters` テーブル追加（マイグレーション）
2. カウンタ値取得SQL実装
3. 統計タブにカウンタ表示UI追加
4. リセット機能実装
5. 初回視聴時の自動開始実装
6. 動作確認テスト

**所要時間**: 2-3時間

**依存**: なし（独立実装可能）

---

#### フェーズ3: ④データ管理機能

**実装順序**:
1. 新タブ「🗑️ データ管理」追加
2. 検索・フィルタUI実装
3. 削除処理実装
4. 確認ダイアログ実装
5. 動作確認テスト

**所要時間**: 2-3時間

**依存**: なし（独立実装可能）

---

#### フェーズ4: ②UI改善（最後）

**実装順序**:
1. `ui_prototypes/` ディレクトリ作成
2. テストデータ生成（`test_data.py`）
3. 各UIパターン実装（4-5パターン）
4. ユーザー確認・選択
5. 選択されたUIを本番タブに統合
6. ソート・検索機能実装
7. 動作確認テスト

**所要時間**: 4-6時間

**依存**: ①判定機能（判定ボタンを詳細一覧にも配置するため）

---

### 7.2 並行実装の可否

- **①と③**: 並行実装可能（依存なし）
- **①と④**: 並行実装可能（依存なし）
- **②と他**: ①完了後に実装推奨（判定ボタンをUIに組み込むため）

---

## 8. テスト項目

### 8.1 ①判定機能のテスト

| # | テストケース | 期待結果 |
|---|------------|---------|
| 1 | プレフィックスなしファイルにレベル3を判定 | ファイル名が `###_作品名.mp4` に変更、DB更新、画面更新 |
| 2 | `##_作品名.mp4` をレベル4に変更 | ファイル名が `####_作品名.mp4` に変更 |
| 3 | `###_作品名.mp4` をレベル0に変更 | ファイル名が `_作品名.mp4` に変更 |
| 4 | ファイルを開いている状態で判定実行 | エラー表示「ファイルが使用中です」、DB更新なし |
| 5 | OneDrive同期中に判定実行 | エラー表示、DB更新なし |
| 6 | 既存レベルと同じレベルを選択 | リネーム不要、メッセージ表示「既に同じレベルです」 |
| 7 | essential_filename の維持確認 | リネーム後も `essential_filename` は変わらない |

### 8.2 ③カウンタ機能のテスト

| # | テストケース | 期待結果 |
|---|------------|---------|
| 1 | 初回視聴時のカウンタ動作 | 3つ全てのカウンタが1回にカウントアップ、開始日時記録 |
| 2 | 2回目以降の視聴 | 3つ全てのカウンタが +1 |
| 3 | カウンタAをリセット | 確認ダイアログ表示 → 0回にリセット、新しい開始日時記録 |
| 4 | リセット後の視聴 | リセットしたカウンタのみ +1（他は影響なし） |
| 5 | 未使用状態の表示 | `0回（未使用）` と表示 |
| 6 | 日時表示形式確認 | `YYYY-MM-DD HH:MM` 形式で表示 |

### 8.3 ④データ管理機能のテスト

| # | テストケース | 期待結果 |
|---|------------|---------|
| 1 | タイトル検索（部分一致） | 「作品」で検索 → 「作品A」「作品B」が表示 |
| 2 | 大文字小文字区別なし検索 | 「abc」で検索 → 「ABC」「Abc」も表示 |
| 3 | お気に入りレベルでフィルタ | レベル3のみ表示 |
| 4 | 視聴回数でフィルタ | 0回のみ表示 |
| 5 | 削除実行 | 確認ダイアログ → DB削除（CASCADE）、成功メッセージ |
| 6 | 削除キャンセル | 確認ダイアログで「いいえ」 → 削除されない |
| 7 | 物理ファイルの確認 | 削除後もファイルシステムにファイルが残っている |

### 8.4 ②UI改善のテスト

| # | テストケース | 期待結果 |
|---|------------|---------|
| 1 | 視聴回数の表示 | 各動画に視聴回数が表示される |
| 2 | ソート機能（視聴回数降順） | 視聴回数の多い順に並ぶ |
| 3 | タイトル検索 | 部分一致で絞り込み |
| 4 | 詳細展開 | 展開ボタンクリックで詳細情報表示 |
| 5 | 100件以上の動画表示 | スクロールで全件表示可能 |

---

## 9. 注意事項とリスク

### 9.1 ファイルリネームのリスク

#### 9.1.1 OneDrive同期の影響

**リスク**: OneDrive同期中にリネームすると失敗する可能性

**対策**:
- PermissionError を適切にハンドリング
- エラーメッセージで「同期完了後に再試行」を案内
- DB更新をロールバック（リネーム失敗時はDB更新しない）

#### 9.1.2 ファイル使用中の検出

**リスク**: ファイルを開いている状態でリネームすると失敗

**対策**:
- PermissionError をキャッチ
- エラーメッセージで「プレイヤーを閉じてください」と案内

#### 9.1.3 パス長制限（Windows）

**リスク**: ファイルパスが260文字を超えるとエラー（Windows制限）

**対策**:
- プレフィックス追加により文字数が増加するため、元のパスが長い場合は注意
- 必要に応じて警告メッセージ表示

### 9.2 データベースのリスク

#### 9.2.1 CASCADE削除の影響

**リスク**: 誤って削除すると viewing_history も失われる

**対策**:
- 確認ダイアログで「関連する視聴履歴（X件）も削除されます」と明示
- スナップショット機能で定期的にバックアップ推奨

#### 9.2.2 マイグレーションの失敗

**リスク**: `counters` テーブル作成時にエラー

**対策**:
- `CREATE TABLE IF NOT EXISTS` で既存テーブルを保護
- `INSERT OR IGNORE` で重複挿入を防止
- 起動時のエラーログを確認

### 9.3 パフォーマンスのリスク

#### 9.3.1 カウンタのSQL集計

**リスク**: viewing_history が数万件になるとカウンタ計算が遅くなる可能性

**対策**:
- 現状1000件程度なので問題なし
- 将来的に遅くなった場合はインデックス追加またはカウント方式変更を検討

#### 9.3.2 UI改善での大量データ表示

**リスク**: 100件以上の動画を一度に表示するとStreamlitが重くなる可能性

**対策**:
- コンパクト表示 + 展開式で情報量を調整
- 必要に応じてページネーション機能を追加（将来対応）

### 9.4 運用上の注意

#### 9.4.1 判定後の手動スキャン

**注意**: 判定（リネーム）後、手動スキャンを実行すると essential_filename が再計算される

**推奨**: 判定機能を使う場合、手動スキャンは不要（rerunで反映されるため）

#### 9.4.2 カウンタのリセットタイミング

**注意**: リセット操作は取り消しできない

**推奨**: 月初や週初など、定期的なタイミングでリセットする運用を推奨

#### 9.4.3 データ管理機能の削除範囲

**注意**: 削除は即座に実行され、取り消しできない

**推奨**: スナップショット機能で事前にバックアップを取得

---

## 10. 実装チェックリスト

### 10.1 ①判定機能

- [ ] 星評価UIの実装
- [ ] 判定ボタンの配置
- [ ] 既存レベルの初期表示
- [ ] リネーム処理の実装
- [ ] DB更新処理
- [ ] エラーハンドリング（PermissionError, FileNotFoundError等）
- [ ] 成功時の自動rerun
- [ ] 動作テスト（全ケース）

### 10.2 ③カウンタ機能

- [ ] `counters` テーブル作成（マイグレーション）
- [ ] カウンタ値取得SQL実装
- [ ] 統計タブにUI追加
- [ ] リセット機能実装
- [ ] 確認ダイアログ実装
- [ ] 初回視聴時の自動開始実装
- [ ] 日時表示形式の調整
- [ ] 動作テスト（全ケース）

### 10.3 ④データ管理機能

- [ ] 新タブ追加
- [ ] 検索UI実装（正規化処理含む）
- [ ] フィルタUI実装（レベル、視聴回数）
- [ ] 削除処理実装（CASCADE）
- [ ] 確認ダイアログ実装
- [ ] 成功メッセージ表示
- [ ] 動作テスト（全ケース）

### 10.4 ②UI改善

- [ ] `ui_prototypes/` ディレクトリ作成
- [ ] テストデータ生成
- [ ] UIパターン実装（4-5パターン）
- [ ] ユーザー確認・選択
- [ ] 本番タブへの統合
- [ ] ソート機能実装
- [ ] 検索機能実装
- [ ] フィルタ機能実装
- [ ] 動作テスト（全ケース）

---

## 11. 参考資料

### 11.1 関連ドキュメント

- `docs/AGENT_SYSTEM_OVERVIEW.md`: 現行システムの詳細仕様
- `docs/技術仕様書.md`: 既存の技術仕様
- `docs/要件定義書.md`: 当初の要件定義

### 11.2 実装参考

- `streamlit_app.py`: メインUI実装
- `core/scanner.py`: ファイルスキャン・リネーム処理
- `core/video_manager.py`: 動画管理・視聴履歴記録
- `core/database.py`: DB初期化・マイグレーション

---

## 12. 質疑応答記録

本要件定義は、2026-01-02に実施した詳細なヒアリングに基づいて策定されました。以下、全質疑応答の記録を示します。

### 12.1 初期要求（ユーザーからの提示）

ユーザーから以下の4つの改良要求が提示されました：

1. **①判定機能**: アプリ経由で視聴した際に任意で判定結果を付与し、「###_」「##_」「#_」「_」の文字を先頭に付与させたい
2. **②UI改善**: 動画一覧の表示が見にくいため、複数のUIパターンを提示してほしい。`ui_prototypes/`ディレクトリで作業
3. **③カウンタ機能**: 自動車の走行距離メーターのように、3つほどのカウンタを使い分けて特定期間の利用を集計したい
4. **④データ管理機能**: DBに残っているデータに対して任意で手動によってファイルの情報を削除したい

### 12.2 ①判定機能に関する質疑応答

#### Q1-1: 判定結果の付与タイミングについて
**質問**: 再生ボタンを押した直後に判定入力のUIが表示される形か、それとも別の場所で後から判定を付与する形か？

**回答**: 再生ボタンの隣に判定可能なボタンを配置。再生操作と判定操作は同じ画面で行いたい。

**決定事項**: 動画一覧の各行に判定UIを配置（タブ切り替え不要）

---

#### Q1-2: 判定基準について
**質問**: この新しい判定は、お気に入りレベルとは別の評価軸か、それともお気に入りレベルを置き換える形か？

**回答**: 現在のお気に入りレベルと同じ判定軸です。

**決定事項**: 既存のお気に入りレベルシステムと統合

---

#### Q1-3: ファイル名の変更について
**質問**: 実際のファイル名を物理的にリネームするのか、それともDB上の表示名だけを変更するのか？

**回答**: 実際のファイル名を変更する。リネームしたらDB上の表示名も併せて変更させたい。

**決定事項**: 物理ファイルリネーム + DB更新

---

#### Q1-4: 既存のプレフィックスとの関係
**質問**: この新しい判定システムは、現在のお気に入りレベルと統合する形か？

**回答**: 新しい判定システムは、現在のお気に入りレベルと統合する形で良い。

**決定事項**: 既存システムとの統合

---

#### Q1-5: 判定の選択肢
**質問**: 「####_」「###_」「##_」「#_」「_」の段階で良いか？「判定なし（変更しない）」という選択肢も必要か？

**回答**: 現在の「####_」「###_」「##_」「#_」「_」の4段階（実際は5段階）で良い。「判定なし（変更しない）」という選択肢も必要。

**決定事項**: 5段階 + 判定なしオプション

---

#### Q1-6: 判定レベルの範囲について
**質問**: レベル5（`#####_`）は不要か？「`_`」は何を意味するか？

**回答**: レベル5（`#####_`）は不要で、レベル4が最高。「`_`」はレベル0を明示的にマークする。

**決定事項**: レベル0-4の5段階、「`_`」はレベル0マーク

---

#### Q1-7: 判定UIの形式
**質問**: ドロップダウンで選択 → 「判定」ボタンか、各レベルごとに個別のボタンか？

**回答**: アクティブな☆☆☆☆を配置し、ユーザーがレベルを選択した後に「判定」ボタンをクリック。

**決定事項**: 星評価UI + 判定ボタン

---

#### Q1-8: リネーム処理について
**質問**: プレフィックスなし → レベル追加、レベル2 → レベル3への変更、レベル3 → プレフィックス削除の動作確認

**回答**:
- 例1（プレフィックスなし → レベル3）は求めている機能
- 例2（レベル2 → レベル3）はあると嬉しい
- 例3（プレフィックス削除）は不要

**決定事項**: プレフィックス追加・変更対応、削除は不要

---

#### Q1-9: リネーム失敗時の処理
**質問**: リネーム失敗時はエラー表示してDB更新もキャンセルするか？

**回答**: リネーム失敗時はエラー表示して、DB更新もキャンセルする。

**決定事項**: 失敗時はロールバック

---

#### Q1-10: 判定後のスキャン
**質問**: 判定（リネーム）後、自動的にファイル再スキャンを実行するか？

**回答**: 手動でスキャンボタンを押すまで待つ。

**決定事項**: 手動スキャン

---

#### Q1-11: 一括判定の必要性
**質問**: 複数の動画に対して一括で判定を付与する機能は必要か？

**回答**: 必要ない（1件ずつ判定する）。

**決定事項**: 一括判定機能なし

---

#### Q1-12: 星評価UIの操作方法
**質問**: 星をクリックすると塗りつぶされるか、ホバーしてプレビュー → クリックで確定か？

**回答**: 星をホバーしてプレビュー → クリックで確定。

**決定事項**: ホバープレビュー方式

---

#### Q1-13: 現在のレベルの初期表示
**質問**: 既に「##_」が付いている動画は、初期状態で「★★☆☆」と表示されるか？

**回答**: 既に「##_」が付いている動画は、初期状態で「★★☆☆」と表示されるようにしたい。

**決定事項**: 既存レベルを初期表示

---

#### Q1-14: 判定ボタンの配置
**質問**: [タイトル] [メタ情報] [☆☆☆☆] [判定] [再生] のようなレイアウトで良いか？

**回答**: このようなレイアウトで良い。

**決定事項**: 承認

---

#### Q1-15: 判定完了後の表示
**質問**: 成功メッセージ表示 → 手動で画面更新（rerun不要）か、自動的に画面更新（st.rerun）か？

**回答（初回）**: 成功メッセージ表示 → 手動で画面更新（rerun不要）。

**回答（修正・Q1-19）**: 自動で画面更新（rerun必要）するようにしてください。

**決定事項**: 自動rerun

---

#### Q1-16: 星UIの実装について
**質問**: カスタムHTML/CSSで実装する形で良いか、それともシンプルなボタン形式でも許容できるか？

**回答**: 標準で代替できる機能でOK。シンプルなボタン形式でも許容できる。

**決定事項**: シンプルなボタン形式も許容

---

#### Q1-17: 判定失敗時の詳細
**質問**: 「ファイルが使用中です」「OneDrive同期中のため失敗」などのエラーメッセージで良いか？

**回答**: このようなエラーメッセージで良い。

**決定事項**: 承認

---

#### Q1-18: プレフィックス変更の挙動確認
**質問**: essential_filename は「作品名.mp4」のまま（本質名は変わらない）か？

**回答**: essential_filename は本質名（プレフィックスなし）を保存し、これは維持する。

**決定事項**: essential_filename維持

---

#### Q1-19: 判定後の画面反映について（Q1-15の修正）
**質問**: 成功メッセージのみで表示は古いままか、DB上の表示だけは即座に更新するか？

**回答**: 自動で画面更新（rerun必要）するようにしてください。

**決定事項**: st.rerun()で自動更新

---

#### Q1-20: 判定履歴の記録
**質問**: 判定を変更した履歴（監査ログ）を記録するか？

**回答**: 記録しない（最新のレベルのみDB保持）。

**決定事項**: 履歴記録なし

---

#### Q1-21: 判定機能の対象
**質問**: 全ての動画に判定ボタンを表示するか？

**回答**: すべての動画に判定ボタンを表示（既にプレフィックスがある動画も変更可能）。

**決定事項**: 全動画対象

---

### 12.3 ②UI改善に関する質疑応答

#### Q2-1: 現状の不満点
**質問**: 現在の動画一覧で特に見にくいと感じる点は？

**回答**:
- 重要な情報が見つけにくい
- レイアウトが窮屈
- 色やコントラストの問題
- スクロールせずにたくさんの動画情報を表示させたい
- 統計タブで表示している視聴回数も表示させたい

**決定事項**: 上記を改善対象として特定

---

#### Q2-2: 表示したい情報の優先順位
**質問**: 優先度が高いものは？

**回答**:
1. タイトル（essential_filename）
2. お気に入りレベル
3. 保存場所（Cドライブ/外付けHDD）
4. 視聴回数（現在は未表示）

**決定事項**: 上記を優先表示

---

#### Q2-3: UIパターンの希望
**質問**: カード型、テーブル型、リスト型、グリッド型のどれを見たいか？

**回答**: すべて見てみたい。

**決定事項**: 複数パターン作成

---

#### Q2-4: 動画の件数
**質問**: 通常、一覧には何件くらい表示されるか？

**回答**: 100件以上。

**決定事項**: 大量データ対応

---

#### Q2-5: その他の表示情報
**質問**: 登場人物、ファイルサイズ、最終更新日時、最終視聴日時、ファイルパス、メモ、登録日時のうち表示したいものは？

**回答**:
- 登場人物（performer）
- 最終視聴日時
- ファイルパス（フルパス）

**決定事項**: 上記を展開式で表示

---

#### Q2-6: 視聴回数の表示方法
**質問**: 数値のみ、バッジ形式、プログレスバー、色分けのどれが良いか？

**回答**: 数値のみ（例：「5回」）。

**決定事項**: シンプルな数値表示

---

#### Q2-7: ソート機能
**質問**: どの項目でソートしたいか？

**回答**: 視聴回数順、最終視聴日時順、タイトル順などの項目でソートしたい。

**決定事項**: 複数ソート対応

---

#### Q2-8: フィルタリング
**質問**: 一覧内でのクイックフィルタは必要か？

**回答**: 必要。タイトル検索ボックスと視聴回数範囲指定。

**決定事項**: タイトル検索 + 視聴回数フィルタ

---

#### Q2-9: ページネーション
**質問**: すべてスクロール表示、ページネーション、無限スクロールのどれが良いか？

**回答**: すべてスクロール表示（現状維持）。

**決定事項**: ページネーションなし

---

#### Q2-10: 行の高さ・密度
**質問**: コンパクト表示か、重要情報のみ表示（詳細は展開式）か？

**回答**: A) コンパクト表示とB) 重要情報のみ表示（詳細は展開式）の併用。

**決定事項**: コンパクト + 展開式

---

#### Q2-11: 詳細展開の内容
**質問**: 初期表示と展開後に表示する情報の分類で良いか？

**回答**: 提案の分類で良い。

**決定事項**: 承認

---

#### Q2-12: ソート順の保持
**質問**: セッション中のみ保持か、設定ファイルに保存か？

**回答**: セッション中のみ保持（ブラウザ更新で初期化）で良い。

**決定事項**: セッションのみ保持

---

#### Q2-13: 新UIの適用方法
**質問**: 既存タブを置き換えるか、新しいタブを追加するか？

**回答**: 新しいタブを追加（例：「📋 詳細一覧」）して、古いタブも残す。

**決定事項**: 新タブ追加、既存タブ保持

---

#### Q2-14: タイトル検索の動作
**質問**: 部分一致、AND検索、OR検索、正規表現対応のどのレベルが必要か？

**回答**: 部分一致（「ABC」を含む）。ただし半角全角、大文字小文字、カタカナひらがななどは区別せずに検索したい。

**決定事項**: 正規化した部分一致検索

---

#### Q2-15: UIプロトタイプの数
**質問**: 何パターンのプロトタイプを作成するか？

**回答**: お任せ。

**決定事項**: 4-5パターン程度

---

### 12.4 ③カウンタ機能に関する質疑応答

#### Q3-1: カウンタの目的
**質問**: 特定期間の視聴回数測定か、特定目的での視聴回数か？

**回答**: 「今日からの視聴回数をカウントしたい」と思ったときに設定できるように。3つとも同様にカウントし、独立してリセット可能にする。

**決定事項**: 柔軟な期間測定

---

#### Q3-2: カウンタの数
**質問**: 3つで固定で良いか、可変か？

**回答**: 3つで固定で良い。

**決定事項**: 固定3つ

---

#### Q3-3: カウンタの名前
**質問**: 各カウンタには名前を付けられるか？

**回答**: 単に「カウンタA」「カウンタB」「カウンタC」で良い。

**決定事項**: 固定名称

---

#### Q3-4: カウント対象
**質問**: APP_PLAYBACKのみか、すべてのviewing_historyか？

**回答**: すべての viewing_history。

**決定事項**: 全viewing_history対象

---

#### Q3-5: カウントのタイミング
**質問**: 再生時に自動的にカウントか、選択してカウントか？

**回答**: 再生時に自動的にカウント。

**決定事項**: 自動カウント

---

#### Q3-6: リセット操作
**質問**: 即リセット、確認ダイアログ後リセット、バックアップ/履歴保存のどれか？

**回答**: 確認ダイアログ表示後リセット。

**決定事項**: 確認ダイアログあり

---

#### Q3-7: 表示場所
**質問**: サイドバー、専用タブ、統計タブ内のどこに表示するか？

**回答**: 統計タブ内。

**決定事項**: 統計タブ上部

---

#### Q3-8: カウント開始日時の記録
**質問**: 「カウンタA: 125回（2026-01-02 10:00 から）」のような表示で良いか？

**回答**: このような表示で良い。

**決定事項**: 承認

---

#### Q3-9: カウンタのリセット時の動作
**質問**: リセット後は0回（現在時刻で再スタート）で良いか？

**回答**: この動作（リセット = ゼロ化 + 即座に再開）で良い。

**決定事項**: リセット = ゼロ化 + 再開

---

#### Q3-10: カウンタの計算方法
**質問**: リアルタイム計算（SQL集計）か、カウント時に加算か？

**回答**: 実装難易度が低いものにしてほしい。

**決定事項**: リアルタイムSQL集計（実装が簡単）

---

#### Q3-11: カウンタのデータ保存場所
**質問**: app_settings.jsonに保存か、新しいテーブルcountersを作成か？

**回答**: 新しいテーブル counters を作成。

**決定事項**: 新テーブル作成

---

#### Q3-12: 統計タブ内の配置
**質問**: 統計タブの上部に配置で良いか？

**回答**: 提案してもらった統計タブの上部に配置で良い。

**決定事項**: 承認

---

#### Q3-13: カウンタの開始日時の表示形式
**質問**: 秒まで表示、分まで表示、日付のみのどれが良いか？

**回答**: 分まで表示（2026-01-02 10:00）。

**決定事項**: 分まで表示

---

#### Q3-14: カウンタの同時動作（非常に重要）
**質問**: 1回の視聴時に3つ全てが同時にカウントアップか、ユーザーが選択した1つだけカウントアップか？

**回答**: 3つ全てが同時にカウントアップ。

**決定事項**: 全カウンタ同時加算

---

#### Q3-15: カウンタの開始方法
**質問**: 「カウント開始」ボタンを押すか、最初の視聴時に自動的に開始か？

**回答**: 最初の視聴時に自動的に開始（3つ全てが同時に開始）。

**決定事項**: 初回視聴で自動開始

---

#### Q3-16: カウンタのリセットと再開
**質問**: リセット = ゼロに戻して即座に再開で良いか、それとも停止状態に戻るか？

**回答**: この動作（リセット = ゼロ化 + 即座に再開）で良い。

**決定事項**: 即座に再開

---

### 12.5 ④データ管理機能に関する質疑応答

#### Q4-1: 削除対象
**質問**: videosテーブルのレコード削除（ファイル情報のみ削除、物理ファイルは残る）か、物理ファイルも削除か？

**回答**: videosテーブルのレコード削除（ファイル情報のみ削除、物理ファイルは残る）。

**決定事項**: DBのみ削除

---

#### Q4-2: 削除のトリガー
**質問**: 動画一覧の各行に「削除」ボタンか、専用の管理タブか？

**回答**: 専用の管理タブ。

**決定事項**: 専用タブ作成

---

#### Q4-3: 削除の確認
**質問**: 確認ダイアログのみ、確認 + ファイル名入力、削除前にバックアップ作成、論理削除のどれか？

**回答**: 確認ダイアログのみ。

**決定事項**: 確認ダイアログのみ

---

#### Q4-4: 関連データの扱い
**質問**: viewing_history / play_history は一緒に削除（CASCADE）か、残すか？

**回答**: 一緒に削除（CASCADE）。

**決定事項**: CASCADE削除

---

#### Q4-5: 管理タブの名前とレイアウト
**質問**: タブ名は「🗑️ データ管理」で良いか？レイアウトは提案通りで良いか？

**回答**: タブ名「🗑️ データ管理」、レイアウトは提案のようなイメージで良い。

**決定事項**: 承認

---

#### Q4-6: 検索・フィルタ機能
**質問**: タイトル検索、お気に入りレベルでフィルタ、視聴回数でフィルタのどれが必要か？

**回答**: タイトル検索、お気に入りレベルでフィルタ、視聴回数でフィルタ（例：0回のみ表示）が必要。

**決定事項**: 全機能実装

---

#### Q4-7: 削除後の表示
**質問**: 成功メッセージのみか、成功メッセージ + 一覧を自動更新（st.rerun）か？

**回答**: 成功メッセージのみ表示。

**決定事項**: rerunなし

---

#### Q4-8: 一括削除の必要性
**質問**: 複数レコードを一度に削除する機能は必要か？

**回答**: 不要（1件ずつ削除）。

**決定事項**: 一括削除なし

---

#### Q4-9: 削除の安全装置
**質問**: 即座に実行（物理削除）で良いか、削除フラグを立てる仕組みが必要か？

**回答**: 削除は即座に実行で良い。DBのみで良い。実際のファイル自体は削除などしなくてよい。

**決定事項**: 即座に物理削除（DBのみ）

---

### 12.6 全体に関する質疑応答

#### Q5-1: 開発の優先順位
**質問**: どの順番で実装してほしいか？

**回答**: 優先順位は①→③→④→②。

**決定事項**: ①判定 → ③カウンタ → ④削除 → ②UI改善

---

#### Q5-2: フロント開発ディレクトリ
**質問**: ディレクトリ名は？複数の検証用アプリを作成する形で良いか？

**回答**: ディレクトリ名は `ui_prototypes`。この中に複数の検証用アプリ（pattern_a.py, pattern_b.py など）を作成する形で良い。

**決定事項**: ui_prototypes/で複数パターン

---

### 12.7 データベースに関する質疑応答

#### Q6-1: データベースマイグレーション
**質問**: setup_db.pyを手動実行、アプリ起動時に自動的にテーブル追加、専用のマイグレーションスクリプトのどれが良いか？

**回答**: アプリ起動時に自動的にテーブル追加（既存の init_database() と同様）。

**決定事項**: 自動マイグレーション

---

#### Q6-2: 既存データへの影響
**質問**: カウンタ設定以降のviewing_historyのみカウントするか、過去の履歴も遡ってカウントするか？

**回答**: カウンタ設定以降の viewing_history のみカウントする。

**決定事項**: 過去データは対象外

---

### 12.8 仕様決定プロセスの総括

**ヒアリング期間**: 2026-01-02
**質問総数**: 46問（Q1: 21問、Q2: 15問、Q3: 16問、Q4: 9問、Q5: 2問、Q6: 2問）
**重要な仕様変更**:
- Q1-19: 判定後の画面反映を手動から自動（rerun）に変更
- Q3-14: カウンタの動作を「選択式」から「全カウンタ同時加算」に明確化

**策定方針**:
1. 段階的詳細化：初期要求から具体的な仕様へ段階的に詳細化
2. ユーザー主導：すべての仕様決定はユーザーの回答に基づく
3. 実装難易度考慮：ユーザーの「力を掛ける必要はない」という方針を尊重
4. トレーサビリティ：すべての仕様に質問番号を明記し、決定根拠を明確化

---

**以上**

本ドキュメントの各仕様は、上記の質疑応答に基づいて策定されています。仕様変更が必要な場合は、該当する質問番号を参照し、変更理由を明確にした上で更新してください。
