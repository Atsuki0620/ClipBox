# 選択中カード強調表示 修正計画書

作成日: 2026年1月17日  
バージョン: 1.0  
ステータス: 修正準備中

---

## 1. 概要

動画一覧タブおよび未判定ランダムタブで、選択中のカードを視覚的に強調表示する機能が動作していない問題を修正する。

### 問題の要約
- CSSセレクタが間違った要素をターゲットにしているため、背景色・枠線・影の変更が視覚的に見えない
- コードロジック自体は正しく実装されている
- セレクタを1行変更するだけで解決可能

### 修正方針
- **修正案1**（推奨）を採用：外側のdiv（borderを持つ要素）をターゲットにするようCSSセレクタを変更

---

## 2. 背景

### 2.1 ユーザー要求（過去チャットより）

| 項目 | 内容 |
|------|------|
| **基本要求** | 再生・判定・レベル選択時に該当カードの色を変えて操作対象を明示 |
| **採用方式** | 背景色（薄いオレンジ）+ 枠線（太くオレンジ色） |
| **持続時間** | 次の操作をするまで永続的に表示 |
| **排他性** | 常に1つのカードのみ選択状態 |
| **対象操作** | 再生ボタン・判定ボタン・レベル選択のすべて |

### 2.2 現状の問題

**実装計画書（Progress Log）の記載**:
```
⚠️ 未解決課題: 選択中カード強調表示が実際には動作していない
- CSS実装済み（`:has(.cb-selected)`）だが視覚的に確認できず
- 原因調査と修正が必要（Streamlitのレンダリング順序やCSSの優先順位の問題の可能性）
```

### 2.3 根本原因の特定

#### Streamlitの実際のHTML構造

```html
<!-- 外側: border を持つラッパー -->
<div class="st-emotion-cache-xxxxx" style="border: 1px solid ...;">
  <!-- 内側: コンテンツ領域 -->
  <div data-testid="stVerticalBlock">
    <div class="cb-card-marker cb-selected"></div>
    <!-- その他のコンテンツ -->
  </div>
</div>
```

#### 現在のCSSセレクタ（問題あり）

```css
div[data-testid="stVerticalBlock"]:has(.cb-selected) {
    background: linear-gradient(180deg, #fff7ed 0%, #ffe8cc 100%) !important;
    border: 3px solid #f59e0b !important;
    /* ... */
}
```

**問題点**:
- このセレクタは **内側のdiv** をターゲットにしている
- しかし、**borderを持つのは外側のdiv**
- そのため、スタイル変更が視覚的に見えない

---

## 3. 修正内容

### 3.1 修正対象ファイル

**ファイル**: `ui/components/video_card.py`  
**行数**: 29-36行

### 3.2 修正前のコード

```python
st.markdown(
    """
    <style>
/* カードマーカー（非表示） */
.cb-card-marker { display: none; }

/* 選択中のカード強調表示 */
div[data-testid="stVerticalBlock"]:has(.cb-selected) {
    background: linear-gradient(180deg, #fff7ed 0%, #ffe8cc 100%) !important;
    border: 3px solid #f59e0b !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35) !important;
    padding: 4px !important;
}
    </style>
    """,
    unsafe_allow_html=True,
)
```

### 3.3 修正後のコード

```python
st.markdown(
    """
    <style>
/* カードマーカー（非表示） */
.cb-card-marker { display: none; }

/* 選択中のカード強調表示 */
div:has([data-testid="stVerticalBlock"] .cb-selected) {
    background: linear-gradient(180deg, #fff7ed 0%, #ffe8cc 100%) !important;
    border: 3px solid #f59e0b !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35) !important;
    padding: 4px !important;
}
    </style>
    """,
    unsafe_allow_html=True,
)
```

### 3.4 変更点

| 変更箇所 | 変更前 | 変更後 |
|---------|--------|--------|
| CSSセレクタ | `div[data-testid="stVerticalBlock"]:has(.cb-selected)` | `div:has([data-testid="stVerticalBlock"] .cb-selected)` |

**変更の意図**:
- 外側のdiv（borderを持つ要素）をターゲットにする
- これにより、背景色・枠線・影の変更が視覚的に見えるようになる

---

## 4. 実施手順

### ステップ1: コード修正

#### 手順

1. **ファイルを開く**
   ```bash
   # エディタで開く
   code C:\Users\atsuk\OneDrive\ドキュメント\GitHub\ClipBox\ui\components\video_card.py
   ```

2. **29-36行を確認**
   - `div[data-testid="stVerticalBlock"]:has(.cb-selected)` という記述を探す

3. **セレクタを修正**
   - 修正前: `div[data-testid="stVerticalBlock"]:has(.cb-selected)`
   - 修正後: `div:has([data-testid="stVerticalBlock"] .cb-selected)`

4. **ファイルを保存**
   - `Ctrl+S` で保存

#### チェックポイント

- [ ] ファイルを正しく開けた
- [ ] 29-36行のCSSセレクタを確認した
- [ ] セレクタを正しく変更した
- [ ] ファイルを保存した
- [ ] 他の部分を誤って変更していないか確認した

---

### ステップ2: 動作確認

#### 手順

1. **アプリを起動**
   ```bash
   cd C:\Users\atsuk\OneDrive\ドキュメント\GitHub\ClipBox
   streamlit run streamlit_app.py
   ```

2. **動画一覧タブで確認**
   - 任意の動画カードの「▶️ 再生」ボタンをクリック
   - カードの背景色が薄いオレンジ色に変わることを確認
   - カードの枠線が太くオレンジ色（3px）に変わることを確認
   - カードに影（box-shadow）が表示されることを確認

3. **別のカードをクリック**
   - 別の動画カードの「▶️ 再生」ボタンをクリック
   - 前のカードの強調表示が解除されることを確認
   - 新しいカードが強調表示されることを確認

4. **判定ボタンで確認**
   - 任意の動画カードの「✓ 判定」ボタンをクリック
   - カードが強調表示されることを確認

5. **未判定ランダムタブで確認**
   - 未判定ランダムタブに移動
   - 任意の動画カードの「▶️ 再生」ボタンをクリック
   - カードが強調表示されることを確認

6. **ブラウザの開発者ツールで確認（オプション）**
   - F12キーで開発者ツールを開く
   - Elementsタブで `.cb-selected` クラスを持つ要素を検索
   - その親要素に背景色・枠線・影が適用されているか確認

#### 期待される動作

| 操作 | 期待される表示 |
|------|---------------|
| 再生ボタンクリック | カードの背景色が薄いオレンジに変わる |
| 再生ボタンクリック | カードの枠線が太くオレンジ色（3px）に変わる |
| 再生ボタンクリック | カードに影（box-shadow）が表示される |
| 判定ボタンクリック | カードが同様に強調表示される |
| 別のカードをクリック | 前のカードの強調が解除され、新しいカードが強調される |

#### チェックポイント

- [ ] 動画一覧タブで再生ボタンクリック時にカードが強調表示される
- [ ] 背景色が薄いオレンジに変わる
- [ ] 枠線が太くオレンジ色に変わる
- [ ] 影が表示される
- [ ] 判定ボタンクリック時にも同様に強調表示される
- [ ] 別のカードをクリックすると前のカードの強調が解除される
- [ ] 未判定ランダムタブでも同様に動作する

#### 問題が発生した場合

もし強調表示が正しく動作しない場合：

1. **ブラウザのキャッシュをクリア**
   - `Ctrl+Shift+R` でハードリフレッシュ

2. **開発者ツールで確認**
   - F12 → Elements タブ
   - `.cb-selected` クラスを持つ要素を検索
   - 親要素のスタイルを確認

3. **修正案2を試す**
   - より具体的なセレクタに変更
   ```css
   div[class*="st-emotion-cache-"]:has([data-testid="stVerticalBlock"] .cb-selected) {
       /* ... */
   }
   ```

---

### ステップ3: 実装計画書の更新

#### 手順

1. **実装計画書を開く**
   ```bash
   code C:\Users\atsuk\OneDrive\ドキュメント\GitHub\ClipBox\docs\実装計画書_UI改善と機能追加_20260115.md
   ```

2. **Progress Logセクションを探す**
   - ファイルの冒頭部分（1-50行あたり）

3. **未解決課題の記述を修正**

   **修正前**:
   ```markdown
   ⚠️ **未解決課題**: 選択中カード強調表示が実際には動作していない
     - CSS実装済み（`:has(.cb-selected)`）だが視覚的に確認できず
     - 原因調査と修正が必要（Streamlitのレンダリング順序やCSSの優先順位の問題の可能性）
   ```

   **修正後**:
   ```markdown
   ✅ **解決済み**: 選択中カード強調表示の問題を修正（2026-01-17）
     - 原因: CSSセレクタが間違った要素をターゲットにしていた
     - 修正: `div:has([data-testid="stVerticalBlock"] .cb-selected)` に変更
     - 結果: 背景色・枠線・影が正しく表示されるようになった
     - 修正ファイル: `ui/components/video_card.py` 29-36行
   ```

4. **バージョン番号を更新**
   - ページ上部のバージョン番号を `1.1` に変更（必要に応じて）

5. **ファイルを保存**

#### チェックポイント

- [ ] 実装計画書を開いた
- [ ] Progress Logセクションを見つけた
- [ ] 未解決課題の記述を「解決済み」に変更した
- [ ] 修正内容を詳しく記載した
- [ ] 修正日付を追加した
- [ ] ファイルを保存した

---

## 5. 期待される結果

### 5.1 視覚的な変化

**修正前**:
- カードをクリックしても見た目が変わらない
- 選択中のカードが分からない

**修正後**:
- 選択中のカードが明確に強調表示される
- 背景色: 薄いオレンジ色（グラデーション）
- 枠線: 太くオレンジ色（3px solid #f59e0b）
- 影: カードが浮き上がったように見える

### 5.2 ユーザー体験の向上

- 動画プレイヤーで視聴後、アプリ画面に戻った時に、どのカードを再生したか即座に分かる
- 判定作業時に、どのカードを操作したか明確に分かる
- 複数のカードを連続で操作する際、現在の作業位置が把握しやすくなる

---

## 6. リスクと対策

### 6.1 想定されるリスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| CSSセレクタが他の要素に誤適用される | 低 | 修正案2（より具体的なセレクタ）を用意 |
| ブラウザによってCSS適用が異なる | 低 | 主要ブラウザ（Chrome, Edge, Firefox）で動作確認 |
| Streamlitのバージョンアップで動作しなくなる | 中 | 実装計画書に詳細な記録を残す |

### 6.2 ロールバック手順

もし問題が発生した場合、以下の手順で元に戻せます：

1. **GitHubでコミット履歴を確認**
   ```bash
   git log --oneline ui/components/video_card.py
   ```

2. **前のバージョンに戻す**
   ```bash
   git checkout <commit-hash> ui/components/video_card.py
   ```

3. **または、手動で修正前のコードに戻す**
   - セレクタを `div[data-testid="stVerticalBlock"]:has(.cb-selected)` に戻す

---

## 7. 完了チェックリスト

### 修正作業

- [ ] `ui/components/video_card.py` の29-36行を修正した
- [ ] 修正内容が正しいことを確認した
- [ ] ファイルを保存した
- [ ] Gitでコミットした（推奨）

### 動作確認

- [ ] アプリを起動した
- [ ] 動画一覧タブで再生ボタンをクリックし、カードが強調表示されることを確認
- [ ] 判定ボタンをクリックし、カードが強調表示されることを確認
- [ ] 別のカードをクリックし、前のカードの強調が解除されることを確認
- [ ] 未判定ランダムタブでも同様に動作することを確認
- [ ] 視覚的に期待通りの表示になっているか確認（背景色・枠線・影）

### ドキュメント更新

- [ ] 実装計画書の「未解決課題」を「解決済み」に変更した
- [ ] 修正内容と日付を記載した
- [ ] ファイルを保存した
- [ ] Gitでコミットした（推奨）

### 最終確認

- [ ] すべてのチェック項目が完了した
- [ ] 問題なく動作している
- [ ] ドキュメントが最新の状態になっている

---

## 8. 補足情報

### 8.1 技術的な詳細

**CSSセレクタの変更内容**:
```css
/* 修正前: 内側のdivをターゲット（動作しない） */
div[data-testid="stVerticalBlock"]:has(.cb-selected) { ... }

/* 修正後: 外側のdivをターゲット（動作する） */
div:has([data-testid="stVerticalBlock"] .cb-selected) { ... }
```

**セレクタの解説**:
- `div:has(X)`: Xを子孫に持つdiv要素
- `[data-testid="stVerticalBlock"]`: data-testid属性が"stVerticalBlock"の要素
- `.cb-selected`: cb-selectedクラスを持つ要素

### 8.2 参考リンク

- [CSS :has() Selector - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/:has)
- [Streamlit Containers](https://docs.streamlit.io/library/api-reference/layout/st.container)

### 8.3 関連ファイル

| ファイル | 役割 |
|---------|------|
| `ui/components/video_card.py` | 動画カードの表示とCSS定義 |
| `ui/library_tab.py` | 動画一覧タブのUI（is_selected判定を含む） |
| `ui/unrated_random_tab.py` | 未判定ランダムタブのUI（is_selected判定を含む） |
| `streamlit_app.py` | 選択状態の管理（st.session_state.selected_video） |

---

## 9. 修正履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-17 | 1.0 | 初版作成 |
| 2026-01-17 | 1.1 | 実装完了 - 代替案（HTMLインジケーター方式）を採用 |

---

## 10. 実装結果報告（2026-01-17追記）

### 10.1 実施した修正

**当初の計画（CSSセレクタ修正）は採用せず、代替案を採用しました。**

#### 採用した方式: HTMLによる視覚的インジケーター

1. **オレンジ色のバー**: 選択されたカードの上部にグラデーションバーを表示
2. **背景色の変更**: タイトル部分の背景を薄いオレンジ色に変更

#### 修正ファイル

| ファイル | 修正内容 |
|---------|---------|
| `ui/components/video_card.py` | 選択カードに視覚的インジケーター（オレンジバー・背景色）を追加 |
| `streamlit_app.py` | `_handle_play()`に`st.rerun()`を追加（再レンダリングのため） |

### 10.2 CSSセレクタ方式を断念した理由

検証の結果、以下の問題が判明しました：

1. **CSS `:has()` セレクタ自体は動作する**
   - ブラウザは`:has()`をサポート
   - セレクタは正しく要素にマッチ（4要素にマッチ確認）

2. **StreamlitのCSS優先順位問題**
   - `!important`を使用しても、Streamlit内部のスタイルに上書きされる
   - `st-emotion-cache-*` クラスによるインラインスタイルが高優先度
   - 様々なセレクタ詳細度を試したが解決できず

3. **JavaScript注入の制限**
   - `st.markdown`の`unsafe_allow_html=True`はHTMLを許可
   - ただし`<script>`タグはサニタイズされ実行されない

### 10.3 採用した解決策

**HTMLで直接スタイルを適用する方式**

```python
# 選択中カードの視覚的インジケーター
if is_selected:
    card.markdown(
        '<div style="background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); '
        'height: 4px; border-radius: 4px; margin: -4px 0 6px 0;"></div>',
        unsafe_allow_html=True,
    )

# タイトル背景色
title_bg = "background: linear-gradient(180deg, #fff7ed 0%, #ffe8cc 100%); ..." if is_selected else ""
```

**メリット**:
- CSSの優先順位問題を回避
- Streamlitの再レンダリング時に確実に反映
- シンプルな実装

**デメリット**:
- カード全体の枠線変更は実現できない（Streamlitの`st.container`の制限）
- 当初計画の「影（box-shadow）」は適用されない

### 10.4 動作確認結果

| 確認項目 | 結果 |
|---------|------|
| 再生ボタンクリック時にカードが強調表示される | ✅ 動作 |
| オレンジ色のバーが表示される | ✅ 動作 |
| タイトル背景が薄いオレンジに変わる | ✅ 動作 |
| 別のカードをクリックすると強調が切り替わる | ✅ 動作 |
| 判定ボタンクリック時にも強調表示される | ✅ 動作 |

### 10.5 今後の改善案

より完全な強調表示（枠線・影）を実現するには、以下の方法が考えられます：

1. **Streamlit Components**を使用してカスタムHTMLコンポーネントを作成
2. **st.container**の代わりに独自のHTMLカードを生成
3. **Streamlitのバージョンアップ**でCSS優先順位問題が解決される可能性を待つ

---

**作成者**: Claude
**レビュー**: 未実施
**承認**: 未実施
